{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto py-10 px-6 bg-white shadow-md rounded-md">

  <!-- Autosave & Draft Name -->
  <div class="flex justify-between items-center mb-4 text-sm text-gray-500">
    <div>
      <label for="draft_name" class="font-medium text-gray-700">Draft name:</label>
      <input type="text" name="draft_name" id="draft_name" value="{{ data.draft_name or '' }}" class="ml-2 border rounded px-2 py-1">
    </div>
    <div id="autosave-status">Last saved: just now</div>
  </div>

  <!-- Visual Step Tracker with Icons -->
  <div class="flex justify-between items-center mb-6 text-sm font-medium text-gray-500">
    {% set steps = [
      (1, 'üë§ Select Employee'),
      (2, '‚ö†Ô∏è Define Concerns'),
      (3, 'üóìÔ∏è Set Dates'),
      (4, 'üè¢ Schedule Meeting'),
      (5, 'üìù Action Plan'),
      (6, '‚úÖ Review & Submit')
    ] %}
    {% for i, label in steps %}
      <div class="flex-1 text-center {% if step == i %}text-ellipse-teal font-bold{% endif %}">
        {{ label }}
      </div>
      {% if i < 6 %}<div class="w-5 h-1 bg-gray-300 mx-1"></div>{% endif %}
    {% endfor %}
  </div>

  <form method="POST" id="wizardForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    {% if step == 1 %}
      <div class="mb-4">
        <label for="employee_id" class="block text-gray-700 font-medium">Select Employee:</label>
        <div class="flex items-center space-x-2">
          <select id="employee_id" name="employee_id" class="border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-[#005b5a]">
            <option value="">-- Select Employee --</option>
            {% for emp in employees %}
              <option value="{{ emp.id }}" {% if data.employee_id == emp.id %}selected{% endif %}>
                {{ emp.first_name }} {{ emp.last_name }}
              </option>
            {% endfor %}
          </select>
          <button type="button" id="openQuickAdd" class="px-3 py-2 bg-[#005b5a] text-white rounded-lg hover:bg-[#004746]">+ Add</button>
        </div>
        <input type="hidden" name="employee_name" id="employee_name" value="{{ data.employee_name or '' }}">
        {% if wizard_errors.employee_id %}
          <p class="text-red-600 text-sm mt-1">{{ wizard_errors.employee_id }}</p>
        {% endif %}
      </div>

      <script>
        // Keep a human-readable name so Step 6 can display it without needing `employees`
        (function () {
          const sel = document.getElementById('employee_id');
          const hidden = document.getElementById('employee_name');
          function setName() {
            const t = sel.options[sel.selectedIndex]?.text || '';
            hidden.value = t;
          }
          sel?.addEventListener('change', setName);
          // initialise on load if already selected
          if (sel && sel.value && !hidden.value) setName();
        })();
      </script>

    {% elif step == 2 %}
<div class="space-y-6">
  <!-- Concerns Textarea -->
  <div>
    <label for="concerns" class="block text-sm font-medium text-gray-700">Describe Concerns:</label>
    <textarea id="concerns" name="concerns" rows="4" class="form-textarea mt-1 block w-full rounded-md border-gray-300 shadow-sm">{{ data.concerns or '' }}</textarea>
    {% if wizard_errors.concerns %}
      <p class="text-red-600 text-sm mt-1">{{ wizard_errors.concerns }}</p>
    {% endif %}
  </div>

  <!-- Concern Category Dropdown -->
  <div>
    <label for="concern_category" class="block text-sm font-medium text-gray-700">Concern Category:</label>
    <select name="concern_category" id="concern_category" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm">
      <option value="">-- Select Category --</option>
      {% for cat in ['Performance', 'Conduct', 'Timekeeping', 'Absence', 'Attitude', 'Communication'] %}
        <option value="{{ cat }}" {% if data.concern_category == cat %}selected{% endif %}>{{ cat }}</option>
      {% endfor %}
    </select>
    {% if wizard_errors.concern_category %}
      <p class="text-red-600 text-sm mt-1">{{ wizard_errors.concern_category }}</p>
    {% endif %}
  </div>

  <!-- Concern Tags (Free Text Input) -->
  <div>
    <label for="concern_tags" class="block text-sm font-medium text-gray-700">Concern Tags (comma-separated):</label>
    <input type="text" name="concern_tags" id="concern_tags" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="e.g. missed deadlines, attitude" value="{{ data.concern_tags or '' }}">
  </div>

  <!-- Severity Dropdown -->
  <div>
    <label for="severity" class="block text-sm font-medium text-gray-700">Severity:</label>
    <select name="severity" id="severity" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm">
      <option value="">-- Select Severity --</option>
      {% for level in ['Low', 'Moderate', 'High'] %}
        <option value="{{ level }}" {% if data.severity == level %}selected{% endif %}>{{ level }}</option>
      {% endfor %}
    </select>
    {% if wizard_errors.severity %}
      <p class="text-red-600 text-sm mt-1">{{ wizard_errors.severity }}</p>
    {% endif %}
  </div>

  <!-- Frequency Dropdown -->
  <div>
    <label for="frequency" class="block text-sm font-medium text-gray-700">Frequency:</label>
    <select name="frequency" id="frequency" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm">
      <option value="">-- Select Frequency --</option>
      {% for freq in ['One-off', 'Occasional', 'Frequent', 'Persistent'] %}
        <option value="{{ freq }}" {% if data.frequency == freq %}selected{% endif %}>{{ freq }}</option>
      {% endfor %}
    </select>
    {% if wizard_errors.frequency %}
      <p class="text-red-600 text-sm mt-1">{{ wizard_errors.frequency }}</p>
    {% endif %}
  </div>
</div>

    {% elif step == 3 %}
      <div class="grid grid-cols-1 gap-4">
        <div>
          <label for="start_date" class="block text-gray-700 font-medium">Start Date:</label>
          <input type="date" name="start_date" id="start_date" class="form-input mt-1 block w-full border rounded px-3 py-2" value="{{ data.start_date or '' }}">
          {% if wizard_errors.start_date %}
            <p class="text-red-600 text-sm mt-1">{{ wizard_errors.start_date }}</p>
          {% endif %}
        </div>
        <div>
          <label for="review_date" class="block text-gray-700 font-medium">Review Date:</label>
          <input type="date" name="review_date" id="review_date" class="form-input mt-1 block w-full border rounded px-3 py-2" value="{{ data.review_date or '' }}">
          {% if wizard_errors.review_date %}
            <p class="text-red-600 text-sm mt-1">{{ wizard_errors.review_date }}</p>
          {% endif %}
        </div>
      </div>

    {% elif step == 4 %}
  <div>
    <label for="meeting_date">Meeting Date:</label>
    <input 
      type="date" 
      id="meeting_date" 
      name="capability_meeting_date" 
      class="form-input w-full mt-2" 
      value="{{ data.get('capability_meeting_date', '') }}"
      required
    >
  </div>

  <div class="mt-4">
    <label for="meeting_time">Time:</label>
    <input 
      type="time" 
      id="meeting_time" 
      name="capability_meeting_time" 
      class="form-input w-full mt-2" 
      value="{{ data.get('capability_meeting_time', '') }}"
      required
    >
  </div>

  <div class="mt-4">
    <label for="meeting_venue">Venue:</label>
    <input 
      type="text" 
      id="meeting_venue" 
      name="capability_meeting_venue" 
      class="form-input w-full mt-2" 
      value="{{ data.get('capability_meeting_venue', '') }}"
      required
    >
  </div>

  <!-- Hidden mirrors for AJAX validator (expects meeting_date / meeting_time) -->
  <input type="hidden" name="meeting_date" id="meeting_date_mirror" value="{{ data.get('capability_meeting_date','') }}">
  <input type="hidden" name="meeting_time" id="meeting_time_mirror" value="{{ data.get('capability_meeting_time','') }}">

  <script>
    (function () {
      const d = document.getElementById('meeting_date');
      const t = document.getElementById('meeting_time');
      const dMirror = document.getElementById('meeting_date_mirror');
      const tMirror = document.getElementById('meeting_time_mirror');
      d?.addEventListener('input', () => dMirror.value = d.value);
      t?.addEventListener('input', () => tMirror.value = t.value);
    })();
  </script>

    {% elif step == 5 %}
      <div>
        <div id="action-plan-list" class="mb-4"></div>
        <button type="button" onclick="addActionItem()" class="text-sm text-ellipse-teal hover:underline mb-4">+ Add Action Item</button>
        <button type="button" onclick="suggestActions()" class="ml-4 text-sm bg-ellipse-teal text-white px-3 py-1 rounded hover:bg-ellipse-hover transition">‚ö° Suggest with AI</button>
        {% if wizard_errors.action_plan_items %}
          <p class="text-red-600 text-sm mt-1">{{ wizard_errors.action_plan_items }}</p>
        {% endif %}

        <div id="next-up-suggestions" class="hidden mt-6">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Next Up Suggestions</h3>
          <div id="suggestion-cards" class="grid grid-cols-1 gap-4"></div>
        </div>
      </div>

    {% elif step == 6 %}
      <div class="space-y-4 text-sm text-gray-700">
        <p><strong>Employee:</strong> {{ data.employee_name or '' }}</p>
        <p><strong>Concerns:</strong> {{ data.concerns }}</p>
        <p><strong>Category:</strong> {{ data.concern_category }}</p>
        <p><strong>Severity:</strong> {{ data.severity }}</p>
        <p><strong>Frequency:</strong> {{ data.frequency }}</p>
        <p><strong>Tags:</strong> {{ data.concern_tags }}</p>
        <p><strong>Start Date:</strong> {{ data.start_date }}</p>
        <p><strong>Review Date:</strong> {{ data.review_date }}</p>
        <p><strong>Meeting Date:</strong> {{ data.capability_meeting_date }}</p>
        <p><strong>Meeting Time:</strong> {{ data.capability_meeting_time }}</p>
        <p><strong>Venue:</strong> {{ data.capability_meeting_venue }}</p>
        <p><strong>Draft Name:</strong> {{ data.draft_name }}</p>
      </div>
    {% endif %}

    <!-- Navigation Buttons -->
    <div class="mt-8 flex flex-wrap justify-between items-center gap-4">
      {% if step > 1 %}
        <a href="{{ url_for('create_pip_wizard') }}?back=true&edit=true" class="text-sm text-ellipse-teal hover:underline font-medium">‚Üê Back</a>
      {% else %}<div></div>{% endif %}

      <div class="flex items-center gap-4">
        <button id="nextBtn" type="button" class="bg-ellipse-teal text-white px-4 py-2 rounded shadow hover:bg-ellipse-hover transition">
          {% if step == 6 %}Submit{% elif step == 5 %}Next: Review{% else %}Next{% endif %}
        </button>
        <button type="button" onclick="saveDraft()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300 transition">
          üíæ Save Draft
        </button>
      </div>
    </div>
  </form>

  <!-- Quick-Add Employee Modal (Ellipse HR styling) -->
  <div id="quickAddModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-4 text-[#005b5a]">Quick Add Employee</h2>
      <form id="quickAddForm" class="space-y-4">
        <div>
          <label class="block font-medium text-gray-700">First Name</label>
          <input type="text" name="first_name" class="border border-gray-300 rounded-lg w-full p-2 focus:outline-none focus:ring-2 focus:ring-[#005b5a]" required>
        </div>
        <div>
          <label class="block font-medium text-gray-700">Last Name</label>
          <input type="text" name="last_name" class="border border-gray-300 rounded-lg w-full p-2 focus:outline-none focus:ring-2 focus:ring-[#005b5a]" required>
        </div>
        <div>
          <label class="block font-medium text-gray-700">Role</label>
          <input type="text" name="role" class="border border-gray-300 rounded-lg w-full p-2 focus:outline-none focus:ring-2 focus:ring-[#005b5a]">
        </div>
        <div>
          <label class="block font-medium text-gray-700">Service</label>
          <input type="text" name="service" class="border border-gray-300 rounded-lg w-full p-2 focus:outline-none focus:ring-2 focus:ring-[#005b5a]">
        </div>
        <div class="flex justify-end space-x-2 pt-4">
          <button type="button" id="cancelQuickAdd" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-[#005b5a] text-white rounded-lg hover:bg-[#004746]">Save</button>
        </div>
      </form>
    </div>
  </div>

</div>

<!-- Consolidated scripts -->
<script>
function addActionItem() {
  const container = document.getElementById("action-plan-list");
  const input = document.createElement("input");
  input.type = "text";
  input.name = "action_plan_items[]";
  input.className = "form-input w-full mt-2 rounded border px-3 py-2";
  input.placeholder = "Enter action item";
  container.appendChild(input);
}

function suggestActions() {
  fetch("{{ url_for('suggest_actions_ai') }}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": document.querySelector('[name=csrf_token]').value
    },
    body: JSON.stringify({
      concerns: document.getElementById("concerns")?.value || '',
      severity: document.getElementById("severity")?.value || '',
      frequency: document.getElementById("frequency")?.value || '',
      tags: document.getElementById("concern_tags")?.value || '',
      category: document.getElementById("concern_category")?.value || ''
    })
  })
  .then(res => res.json())
  .then(data => {
    const container = document.getElementById("action-plan-list");
    container.innerHTML = ""; // Clear previous suggestions

    if (!data.success) {
      console.log("[DEBUG] AI suggestion error:", data.errors || "Unknown error");
      alert("AI suggestion failed to generate actions.");
      return;
    }

    if (Array.isArray(data.actions)) {
      data.actions.forEach(action => {
        const input = document.createElement("input");
        input.type = "text";
        input.name = "action_plan_items[]";
        input.className = "form-input w-full mt-2 rounded border px-3 py-2";
        input.value = action;
        container.appendChild(input);
      });
    }

    const nextWrap = document.getElementById("next-up-suggestions");
    const cards = document.getElementById("suggestion-cards");
    if (nextWrap && cards) {
      cards.innerHTML = "";
      if (Array.isArray(data.next_up) && data.next_up.length > 0) {
        nextWrap.classList.remove("hidden");
        data.next_up.forEach(suggestion => {
          const div = document.createElement("div");
          div.className = "text-sm text-gray-600 p-2 rounded border";
          div.textContent = suggestion;
          cards.appendChild(div);
        });
      } else {
        nextWrap.classList.add("hidden");
      }
    }
  })
  .catch(err => {
    console.error("Failed to get suggestions:", err);
    alert("AI suggestions failed to load.");
  });
}

function saveDraft(callback) {
  const form = document.getElementById("wizardForm");
  const formData = new FormData(form);
  fetch("{{ url_for('save_pip_draft') }}", {
    method: "POST",
    body: formData,
    headers: { "X-CSRFToken": formData.get("csrf_token") }
  })
  .then(res => res.json())
  .then(result => {
    const status = document.getElementById("autosave-status");
    if (status) status.innerText = `Last saved: ${new Date().toLocaleTimeString()}`;
    if (callback) callback();
  })
  .catch(err => {
    console.error("Draft save failed:", err);
    alert("Failed to save draft.");
  });
}

function validateStep(step, callback) {
  const form = document.getElementById("wizardForm");
  const formData = new FormData(form);
  formData.append("step", step);
  fetch("{{ url_for('validate_wizard_step') }}", {
    method: "POST",
    body: formData,
    headers: { "X-CSRFToken": formData.get("csrf_token") }
  })
  .then(response => response.json())
  .then(data => {
    console.log("[DEBUG] Validation response:", data);
    document.querySelectorAll(".wizard-error").forEach(el => el.remove());
    if (!data.success && data.errors) {
      for (const field in data.errors) {
        const input = document.querySelector(`[name="${field}"]`);
        if (input) {
          const p = document.createElement("p");
          p.className = "wizard-error text-red-600 text-sm mt-1";
          p.textContent = data.errors[field];
          input.insertAdjacentElement("afterend", p);
        }
      }
    }
    callback(data.success);
  })
  .catch(err => {
    console.error("Validation error:", err);
    callback(false);
  });
}

const currentStep = {{ step | int }};
document.getElementById("nextBtn").addEventListener("click", function (e) {
  e.preventDefault();
  validateStep(currentStep, function (valid) {
    if (valid) {
      saveDraft(function () {
        document.getElementById("wizardForm").submit();
      });
    }
  });
});

// Quick-Add modal wiring
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("quickAddModal");
  const openBtn = document.getElementById("openQuickAdd");
  const cancelBtn = document.getElementById("cancelQuickAdd");
  const form = document.getElementById("quickAddForm");
  const employeeSelect = document.getElementById("employee_id");

  if (openBtn) {
    openBtn.addEventListener("click", () => {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    });
  }

  if (cancelBtn) {
    cancelBtn.addEventListener("click", () => {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    });
  }

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(form).entries());

      try {
        const res = await fetch("{{ url_for('quick_add_employee') }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token() }}"
          },
          body: JSON.stringify(formData)
        });
        const data = await res.json();

        if (data.success) {
          const opt = document.createElement("option");
          opt.value = data.id;
          opt.textContent = data.display_name;
          opt.selected = true;
          employeeSelect.appendChild(opt);

          // Update hidden display name for Step 6
          const hiddenName = document.getElementById('employee_name');
          if (hiddenName) hiddenName.value = data.display_name;

          form.reset();
          modal.classList.add("hidden");
          modal.classList.remove("flex");

          // Toast
          const toast = document.createElement("div");
          toast.textContent = "‚úÖ Employee added successfully";
          toast.className = "fixed bottom-4 right-4 bg-[#005b5a] text-white py-2 px-4 rounded-lg shadow-lg";
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
        } else {
          alert(data.error || "Error adding employee");
        }
      } catch (err) {
        console.error(err);
        alert("Failed to add employee");
      }
    });
  }
});
</script>
{% endblock %}
