{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto py-10 px-6 bg-white shadow-md rounded-md">

  <!-- Autosave & Draft Name -->
  <div class="flex justify-between items-center mb-4 text-sm text-gray-500">
    <div>
      <label for="draft_name" class="font-medium text-gray-700">Draft name:</label>
      <input type="text" name="draft_name" id="draft_name" value="{{ data.draft_name or '' }}" class="ml-2 border rounded px-2 py-1">
    </div>
    <div id="autosave-status">Last saved: just now</div>
  </div>

  <!-- Visual Step Tracker with Icons -->
  <div class="flex justify-between items-center mb-6 text-sm font-medium text-gray-500">
    {% set steps = [
      (1, 'üë§ Select Employee'),
      (2, '‚ö†Ô∏è Define Concerns'),
      (3, 'üóìÔ∏è Set Dates'),
      (4, 'üè¢ Schedule Meeting'),
      (5, 'üìù Action Plan'),
      (6, '‚úÖ Review & Submit')
    ] %}
    {% for i, label in steps %}
      <div class="flex-1 text-center {% if step == i %}text-ellipse-teal font-bold{% endif %}">
        {{ label }}
      </div>
      {% if i < 6 %}<div class="w-5 h-1 bg-gray-300 mx-1"></div>{% endif %}
    {% endfor %}
  </div>

  <form method="POST" id="wizardForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    {% if step == 1 %}
      <div class="mb-4">
        <label for="employee_id" class="block text-gray-700 font-medium">Select Employee:</label>
        <select name="employee_id" id="employee_id" class="form-select mt-1 block w-full border rounded px-3 py-2">
          <option value="">-- Choose an employee --</option>
          {% for emp in employees %}
            <option value="{{ emp.id }}" {% if data.employee_id == emp.id %}selected{% endif %}>{{ emp.name }}</option>
          {% endfor %}
        </select>
        {% if wizard_errors.employee_id %}
          <p class="text-red-600 text-sm mt-1">{{ wizard_errors.employee_id }}</p>
        {% endif %}
      </div>

    {% elif step == 2 %}
<div class="space-y-6">
  <!-- Concerns Textarea -->
  <div>
    <label for="concerns" class="block text-sm font-medium text-gray-700">Describe Concerns:</label>
    <textarea id="concerns" name="concerns" rows="4" class="form-textarea mt-1 block w-full rounded-md border-gray-300 shadow-sm">{{ data.concerns or '' }}</textarea>
  </div>

  <!-- Concern Category Dropdown -->
  <div>
    <label for="concern_category" class="block text-sm font-medium text-gray-700">Concern Category:</label>
    <select name="concern_category" id="concern_category" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm">
      <option value="">-- Select Category --</option>
      {% for cat in ['Performance', 'Conduct', 'Timekeeping', 'Absence', 'Attitude', 'Communication'] %}
        <option value="{{ cat }}" {% if data.concern_category == cat %}selected{% endif %}>{{ cat }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Concern Tags (Free Text Input) -->
  <div>
    <label for="concern_tags" class="block text-sm font-medium text-gray-700">Concern Tags (comma-separated):</label>
    <input type="text" name="concern_tags" id="concern_tags" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="e.g. missed deadlines, attitude" value="{{ data.concern_tags or '' }}">
  </div>

  <!-- Severity Dropdown -->
  <div>
    <label for="severity" class="block text-sm font-medium text-gray-700">Severity:</label>
    <select name="severity" id="severity" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm">
      <option value="">-- Select Severity --</option>
      {% for level in ['Low', 'Moderate', 'High'] %}
        <option value="{{ level }}" {% if data.severity == level %}selected{% endif %}>{{ level }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Frequency Dropdown -->
  <div>
    <label for="frequency" class="block text-sm font-medium text-gray-700">Frequency:</label>
    <select name="frequency" id="frequency" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm">
      <option value="">-- Select Frequency --</option>
      {% for freq in ['One-off', 'Occasional', 'Frequent', 'Persistent'] %}
        <option value="{{ freq }}" {% if data.frequency == freq %}selected{% endif %}>{{ freq }}</option>
      {% endfor %}
    </select>
  </div>
</div>

    {% elif step == 3 %}
      <div class="grid grid-cols-1 gap-4">
        <div>
          <label for="start_date" class="block text-gray-700 font-medium">Start Date:</label>
          <input type="date" name="start_date" id="start_date" class="form-input mt-1 block w-full border rounded px-3 py-2" value="{{ data.start_date or '' }}">
          {% if wizard_errors.start_date %}
            <p class="text-red-600 text-sm mt-1">{{ wizard_errors.start_date }}</p>
          {% endif %}
        </div>
        <div>
          <label for="review_date" class="block text-gray-700 font-medium">Review Date:</label>
          <input type="date" name="review_date" id="review_date" class="form-input mt-1 block w-full border rounded px-3 py-2" value="{{ data.review_date or '' }}">
          {% if wizard_errors.review_date %}
            <p class="text-red-600 text-sm mt-1">{{ wizard_errors.review_date }}</p>
          {% endif %}
        </div>
      </div>

    {% elif step == 4 %}
  <div>
    <label for="meeting_date">Meeting Date:</label>
    <input 
      type="date" 
      id="meeting_date" 
      name="capability_meeting_date" 
      class="form-input w-full mt-2" 
      value="{{ data.get('capability_meeting_date', '') }}"
      required
    >
  </div>

  <div class="mt-4">
    <label for="meeting_time">Time:</label>
    <input 
      type="time" 
      id="meeting_time" 
      name="capability_meeting_time" 
      class="form-input w-full mt-2" 
      value="{{ data.get('capability_meeting_time', '') }}"
      required
    >
  </div>

  <div class="mt-4">
    <label for="meeting_venue">Venue:</label>
    <input 
      type="text" 
      id="meeting_venue" 
      name="capability_meeting_venue" 
      class="form-input w-full mt-2" 
      value="{{ data.get('capability_meeting_venue', '') }}"
      required
    >
  </div>

    {% elif step == 5 %}
      <div>
        <div id="action-plan-list" class="mb-4"></div>
        <button type="button" onclick="addActionItem()" class="text-sm text-ellipse-teal hover:underline mb-4">+ Add Action Item</button>
        <button type="button" onclick="suggestActions()" class="ml-4 text-sm bg-ellipse-teal text-white px-3 py-1 rounded hover:bg-ellipse-hover transition">‚ö° Suggest with AI</button>
        {% if wizard_errors.action_plan_items %}
          <p class="text-red-600 text-sm mt-1">{{ wizard_errors.action_plan_items }}</p>
        {% endif %}

        <div id="next-up-suggestions" class="hidden mt-6">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Next Up Suggestions</h3>
          <div id="suggestion-cards" class="grid grid-cols-1 gap-4"></div>
        </div>
      </div>

    {% elif step == 6 %}
      <div class="space-y-4 text-sm text-gray-700">
        <p><strong>Employee:</strong> {{ employees | selectattr("id", "equalto", data.employee_id | int) | map(attribute="name") | list | first }}</p>
        <p><strong>Concerns:</strong> {{ data.concerns }}</p>
        <p><strong>Category:</strong> {{ data.concern_category }}</p>
        <p><strong>Severity:</strong> {{ data.severity }}</p>
        <p><strong>Frequency:</strong> {{ data.frequency }}</p>
        <p><strong>Tags:</strong> {{ data.concern_tags }}</p>
        <p><strong>Start Date:</strong> {{ data.start_date }}</p>
        <p><strong>Review Date:</strong> {{ data.review_date }}</p>
        <p><strong>Meeting Date:</strong> {{ data.capability_meeting_date }}</p>
        <p><strong>Meeting Time:</strong> {{ data.capability_meeting_time }}</p>
        <p><strong>Venue:</strong> {{ data.capability_meeting_venue }}</p>
        <p><strong>Draft Name:</strong> {{ data.draft_name }}</p>
      </div>
    {% endif %}

    <!-- Navigation Buttons -->
    <div class="mt-8 flex flex-wrap justify-between items-center gap-4">
      {% if step > 1 %}
        <a href="{{ url_for('create_pip_wizard') }}?back=true&edit=true" class="text-sm text-ellipse-teal hover:underline font-medium">‚Üê Back</a>
      {% else %}<div></div>{% endif %}

      <div class="flex items-center gap-4">
        <button id="nextBtn" type="button" class="bg-ellipse-teal text-white px-4 py-2 rounded shadow hover:bg-ellipse-hover transition">
          {% if step == 6 %}Submit{% elif step == 5 %}Next: Review{% else %}Next{% endif %}
        </button>
        <button type="button" onclick="saveDraft()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300 transition">
          üíæ Save Draft
        </button>
      </div>
    </div>
  </form>
</div>

<script>
function addActionItem() {
  const container = document.getElementById("action-plan-list");
  const input = document.createElement("input");
  input.type = "text";
  input.name = "action_plan_items[]";
  input.className = "form-input w-full mt-2 rounded border px-3 py-2";
  input.placeholder = "Enter action item";
  container.appendChild(input);
}

function suggestActions() {
  fetch("{{ url_for('suggest_actions_ai') }}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": document.querySelector('[name=csrf_token]').value
    },
    body: JSON.stringify({
      concerns: document.getElementById("concerns")?.value || '',
      severity: document.getElementById("severity")?.value || '',
      frequency: document.getElementById("frequency")?.value || '',
      tags: document.getElementById("concern_tags")?.value || '',
      category: document.getElementById("concern_category")?.value || ''
    })
  })
  .then(res => res.json())
  .then(data => {
    const container = document.getElementById("action-plan-list");
    container.innerHTML = ""; // Clear previous suggestions

    if (!data.success) {
      console.log("[DEBUG] AI suggestion error:", data.errors || "Unknown error");
      alert("AI suggestion failed to generate actions.");
      return;
    }

    if (Array.isArray(data.actions)) {
      data.actions.forEach(action => {
        const input = document.createElement("input");
        input.type = "text";
        input.name = "action_plan_items[]";
        input.className = "form-input w-full mt-2 rounded border px-3 py-2";
        input.value = action;
        container.appendChild(input);
      });
    }

    if (Array.isArray(data.next_up) && data.next_up.length > 0) {
      const label = document.createElement("p");
      label.className = "mt-4 font-medium text-sm text-gray-700";
      label.textContent = "Next Up Suggestions:";
      container.appendChild(label);

      data.next_up.forEach(suggestion => {
        const div = document.createElement("div");
        div.className = "text-sm text-gray-600 ml-3";
        div.textContent = "‚Üí " + suggestion;
        container.appendChild(div);
      });
    }
  })
  .catch(err => {
    console.error("Failed to get suggestions:", err);
    alert("AI suggestions failed to load.");
  });
}


function saveDraft(callback) {
  const formData = new FormData(document.getElementById("wizardForm"));
  fetch("{{ url_for('save_pip_draft') }}", {
    method: "POST",
    body: formData,
    headers: { "X-CSRFToken": formData.get("csrf_token") }
  })
  .then(res => res.json())
  .then(result => {
    document.getElementById("autosave-status").innerText = `Last saved: ${new Date().toLocaleTimeString()}`;
    if (callback) callback();
  })
  .catch(err => {
    console.error("Draft save failed:", err);
    alert("Failed to save draft.");
  });
}

function validateStep(step, callback) {
  const formData = new FormData(document.getElementById("wizardForm"));
  formData.append("step", step);
  fetch("{{ url_for('validate_wizard_step') }}", {
    method: "POST",
    body: formData,
    headers: {
      "X-CSRFToken": formData.get("csrf_token")
    }
  })
  .then(response => response.json())
  .then(data => {
    console.log("[DEBUG] Validation response:", data);  // <-- add this
    document.querySelectorAll(".wizard-error").forEach(el => el.remove());
    if (!data.success) {
      for (const field in data.errors) {
        const input = document.querySelector(`[name="${field}"]`);
        if (input) {
          const p = document.createElement("p");
          p.className = "wizard-error text-red-600 text-sm mt-1";
          p.textContent = data.errors[field];
          input.insertAdjacentElement("afterend", p);
        }
      }
    }
    callback(data.success);
  });
}


const currentStep = {{ step | int }};

document.getElementById("nextBtn").addEventListener("click", function (e) {
  e.preventDefault();
  validateStep(currentStep, function (valid) {
    if (valid) {
      saveDraft(function () {
        document.getElementById("wizardForm").submit();
      });
    }
  });
});
</script>
{% endblock %}
