{% extends 'base.html' %}
{% block content %}

{% from "_ui.html" import Button, Field, Input, Select, Textarea, ErrorText, HelpText %}

<div class="max-w-2xl mx-auto py-10 px-6 bg-white shadow-md rounded-md">

  <!-- Autosave & Draft Name -->
  <div class="flex justify-between items-center mb-4 text-sm text-gray-500">
    <div>
      <label for="draft_name" class="font-medium text-gray-700">Draft name:</label>
      <input type="text" name="draft_name" id="draft_name" value="{{ data.draft_name or '' }}" class="ml-2 border rounded px-2 py-1">
    </div>
    <div id="autosave-status">Last saved: just now</div>
  </div>

  {# Compute max-allowed step (server may also pass max_allowed_step) #}
  {% set _max_jinja = 1 %}
  {% if data.employee_id %}{% set _max_jinja = 2 %}{% endif %}
  {% if data.concerns and data.concern_category and data.severity and data.frequency %}{% set _max_jinja = 3 %}{% endif %}
  {% if data.start_date and data.review_date %}{% set _max_jinja = 4 %}{% endif %}
  {% if data.capability_meeting_date and data.capability_meeting_time and data.capability_meeting_venue %}{% set _max_jinja = 5 %}{% endif %}
  {% if data.action_plan_items and data.action_plan_items|select('string')|list %}{% set _max_jinja = 6 %}{% endif %}
  {% set allowed = max_allowed_step if max_allowed_step is defined else _max_jinja %}

  <!-- Visual Step Tracker with Icons (clickable up to max_allowed_step) -->
  <div class="flex justify-between items-center mb-6 text-sm font-medium text-gray-500">
    {% set steps = [
      (1, 'üë§ Select Employee'),
      (2, '‚ö†Ô∏è Define Concerns'),
      (3, 'üóìÔ∏è Set Dates'),
      (4, 'üè¢ Schedule Meeting'),
      (5, 'üìù Action Plan'),
      (6, '‚úÖ Review & Submit')
    ] %}

    {% for i, label in steps %}
      {% set is_enabled = i <= (allowed or 1) %}
      {% set is_current = (step == i) %}

      {% if is_enabled %}
        <a
          href="{{ url_for('create_pip_wizard') }}?goto={{ i }}"
          class="wizard-step flex-1 text-center px-1 transition {% if is_current %}text-ellipse-teal font-bold{% else %}hover:text-ellipse-teal{% endif %}"
          data-step="{{ i }}"
          data-enabled="1"
        >
          {{ label }}
        </a>
      {% else %}
        <div
          class="wizard-step flex-1 text-center px-1 opacity-50 cursor-not-allowed"
          data-step="{{ i }}"
          data-enabled="0"
          aria-disabled="true"
          title="Complete previous steps first"
        >
          {{ label }}
        </div>
      {% endif %}

      {% if not loop.last %}
        <div class="w-5 h-1 mx-1 {% if i < (allowed or 1) %}bg-ellipse-teal{% else %}bg-gray-300{% endif %}"></div>
      {% endif %}
    {% endfor %}
  </div>

  <form method="POST" id="wizardForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

   {% if step == 1 %}
  <div class="mb-4">
    <label for="employee_id" class="block text-gray-700 font-medium">Select Employee:</label>
    <div class="flex items-center space-x-2">
      <select id="employee_id" name="employee_id" class="border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-[#005b5a]">
        <option value="">-- Select Employee --</option>
        {% for emp in employees %}
          <option value="{{ emp.id }}" {% if data.employee_id == emp.id %}selected{% endif %}>
            {{ emp.first_name }} {{ emp.last_name }}
          </option>
        {% endfor %}
      </select>
      <button type="button" id="openQuickAdd" class="px-3 py-2 bg-[#005b5a] text-white rounded-lg hover:bg-[#004746]">+ Add</button>
    </div>
    <input type="hidden" name="employee_name" id="employee_name" value="{{ data.employee_name or '' }}">
    {% if wizard_errors.employee_id %}
      <p class="text-red-600 text-sm mt-1">{{ wizard_errors.employee_id }}</p>
    {% endif %}
  </div>

  <script>
    (function () {
      const sel = document.getElementById('employee_id');
      const hidden = document.getElementById('employee_name');
      function setName() {
        const t = sel.options[sel.selectedIndex]?.text || '';
        hidden.value = t;
      }
      sel?.addEventListener('change', setName);
      if (sel && sel.value && !hidden.value) setName();
    })();
  </script>

{% elif step == 2 %}
  <div class="space-y-6">
    <div>
      <label for="concerns" class="block text-sm font-medium text-gray-700">Describe Concerns:</label>
      <textarea id="concerns" name="concerns" rows="4" class="form-textarea mt-1 block w-full rounded-md border-gray-300 shadow-sm">{{ data.concerns or '' }}</textarea>
      {% if wizard_errors.concerns %}
        <p class="text-red-600 text-sm mt-1">{{ wizard_errors.concerns }}</p>
      {% endif %}
    </div>

    <div>
      <label for="concern_category" class="block text-sm font-medium text-gray-700">Concern Category:</label>
      <select name="concern_category" id="concern_category" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        <option value="">-- Select Category --</option>
        {# will be hydrated by /taxonomy/categories; initial values below are fallback #}
        {% for cat in ['Performance', 'Conduct', 'Timekeeping', 'Attendance', 'Communication', 'Quality of Work', 'Productivity'] %}
          <option value="{{ cat }}" {% if data.concern_category == cat %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
      </select>
      {% if wizard_errors.concern_category %}
        <p class="text-red-600 text-sm mt-1">{{ wizard_errors.concern_category }}</p>
      {% endif %}
    </div>

    <!-- Concern Tags (Free Text Input + Suggested Pills) -->
    <div>
      <label for="concern_tags" class="block text-sm font-medium text-gray-700">Concern Tags (comma-separated):</label>
      <input type="text" name="concern_tags" id="concern_tags"
             class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
             placeholder="e.g. missed deadlines, attitude"
             value="{{ data.concern_tags or '' }}">
      <div id="suggested-tags" class="mt-3 flex flex-wrap gap-2"></div>
      <p class="text-xs text-gray-500 mt-1">Tip: click tags to add/remove; they sync with the box above.</p>
    </div>

    <div>
      <label for="severity" class="block text-sm font-medium text-gray-700">Severity:</label>
      <select name="severity" id="severity" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        <option value="">-- Select Severity --</option>
        {% for level in ['Low', 'Moderate', 'High'] %}
          <option value="{{ level }}" {% if data.severity == level %}selected{% endif %}>{{ level }}</option>
        {% endfor %}
      </select>
      {% if wizard_errors.severity %}
        <p class="text-red-600 text-sm mt-1">{{ wizard_errors.severity }}</p>
      {% endif %}
    </div>

    <div>
      <label for="frequency" class="block text-sm font-medium text-gray-700">Frequency:</label>
      <select name="frequency" id="frequency" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        <option value="">-- Select Frequency --</option>
        {% for freq in ['One-off', 'Occasional', 'Frequent', 'Persistent'] %}
          <option value="{{ freq }}" {% if data.frequency == freq %}selected{% endif %}>{{ freq }}</option>
        {% endfor %}
      </select>
      {% if wizard_errors.frequency %}
        <p class="text-red-600 text-sm mt-1">{{ wizard_errors.frequency }}</p>
      {% endif %}
    </div>
  </div>

{% elif step == 3 %}
  {% if auto_review_populated %}
    <div class="mb-3 rounded-lg border border-teal-200 bg-teal-50 px-4 py-3 text-sm text-teal-900">
      We've auto-populated a <strong>4-week review date</strong> of
      <strong>{{ auto_review_date }}</strong>. You can overwrite this if your review period differs.
    </div>
  {% endif %}

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
    <!-- Start date -->
    <div>
      <label for="start_date" class="block text-sm font-medium text-gray-700">Start date</label>
      <input
        type="date"
        id="start_date"
        name="start_date"
        class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2"
        value="{{ data.start_date or '' }}"
        required
      />
      {% if wizard_errors.start_date %}
        <p class="mt-1 text-sm text-red-600">{{ wizard_errors.start_date }}</p>
      {% endif %}
    </div>

    <!-- Review period (weeks) -->
    <div>
      <label for="review_weeks" class="block text-sm font-medium text-gray-700">Review period (weeks)</label>
      <div class="mt-1 flex items-center gap-2">
        <input
          type="number"
          id="review_weeks"
          name="review_weeks"
          class="w-28 rounded-md border border-slate-300 px-3 py-2"
          min="1" max="52" step="1"
          value="{{ data.get('review_weeks') or 4 }}"
          aria-describedby="review_weeks_help"
        />
        <button type="button" id="reset_review_weeks"
                class="rounded-md border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50">
          Reset
        </button>
      </div>
      <p id="review_weeks_help" class="mt-1 text-xs text-slate-500">
        Changing this recalculates the review date unless you've edited it manually.
      </p>
    </div>

    <!-- Review date -->
    <div>
      <label for="review_date" class="block text-sm font-medium text-gray-700">Review date</label>
      <input
        type="date"
        id="review_date"
        name="review_date"
        class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2"
        value="{{ data.review_date or '' }}"
      />
      {% if wizard_errors.review_date %}
        <p class="mt-1 text-sm text-red-600">{{ wizard_errors.review_date }}</p>
      {% endif %}
    </div>
  </div>

  <!-- Live recalculation (client-side) -->
  <script>
  (function(){
    const start  = document.getElementById('start_date');
    const weeks  = document.getElementById('review_weeks');
    const review = document.getElementById('review_date');
    const reset  = document.getElementById('reset_review_weeks');

    let manualOverride = false;

    function ymd(d) {
      const tzOffsetMs = d.getTimezoneOffset() * 60000;
      const local = new Date(d.getTime() - tzOffsetMs);
      return local.toISOString().slice(0,10);
    }

    function addDays(dateStr, days) {
      const d = new Date(dateStr);
      if (String(d) === 'Invalid Date') return '';
      d.setDate(d.getDate() + days);
      return ymd(d);
    }

    function recalc() {
      if (manualOverride) return;
      if (!start.value)   return;
      const w = parseInt(weeks.value, 10);
      if (isNaN(w) || w < 1) return;
      review.value = addDays(start.value, w * 7);
    }

    // Recalc when start/weeks change
    start.addEventListener('change', recalc);
    weeks.addEventListener('input', recalc);

    // Manual override detection
    review.addEventListener('input', function() {
      manualOverride = true;
    });

    // Reset brings back auto mode and recalculates
    if (reset) {
      reset.addEventListener('click', function() {
        manualOverride = false;
        // Put the weeks back to 4 by design of the Reset button
        if (weeks && weeks.value !== '4') weeks.value = '4';
        recalc();
      });
    }

    // Initial run: if review empty, compute once
    document.addEventListener('DOMContentLoaded', function() {
      if (!review.value) recalc();
    });
  })();
  </script>

{% elif step == 4 %}
  <div>
    <label for="meeting_date">Meeting Date:</label>
    <input
      type="date"
      id="meeting_date"
      name="capability_meeting_date"
      class="form-input w-full mt-2"
      value="{{ data.get('capability_meeting_date', '') }}"
      required
    >
  </div>

  <div class="mt-4">
    <label for="meeting_time">Time:</label>
    <input
      type="time"
      id="meeting_time"
      name="capability_meeting_time"
      class="form-input w-full mt-2"
      value="{{ data.get('capability_meeting_time', '') }}"
      required
    >
  </div>

  <div class="mt-4">
    <label for="meeting_venue">Venue:</label>
    <input
      type="text"
      id="meeting_venue"
      name="capability_meeting_venue"
      class="form-input w-full mt-2"
      value="{{ data.get('capability_meeting_venue', '') }}"
      required
    >
  </div>

  <!-- Hidden mirrors for AJAX validator (expects meeting_date / meeting_time) -->
  <input type="hidden" name="meeting_date" id="meeting_date_mirror" value="{{ data.get('capability_meeting_date','') }}">
  <input type="hidden" name="meeting_time" id="meeting_time_mirror" value="{{ data.get('capability_meeting_time','') }}">

{% elif step == 5 %}
  <div class="space-y-4">
    <!-- Template pack controls -->
    <div class="flex flex-wrap items-end gap-3">
      <div>
        <label for="tpl_category" class="block text-sm font-medium text-gray-700">Template pack</label>
        <input
          type="text" id="tpl_category" readonly
          class="mt-1 w-56 rounded-md border border-gray-300 px-3 py-2 bg-gray-50"
          value="{{ data.concern_category or '' }}"
          title="Derived from Concern Category"
        />
      </div>
      <div>
        <label for="tpl_severity" class="block text-sm font-medium text-gray-700">Severity</label>
        <input
          type="text" id="tpl_severity" readonly
          class="mt-1 w-40 rounded-md border border-gray-300 px-3 py-2 bg-gray-50"
          value="{{ data.severity or '' }}"
          title="Derived from Severity"
        />
      </div>
      <button type="button" id="btnLoadTemplates"
              class="mt-6 inline-flex items-center gap-2 rounded-md border border-gray-300 px-3 py-2 text-sm hover:bg-gray-50">
        üì¶ Load template actions
      </button>
      <button type="button" id="btnInsertTemplates"
              class="mt-6 inline-flex items-center gap-2 bg-ellipse-teal text-white px-3 py-2 rounded-md hover:bg-ellipse-hover text-sm disabled:opacity-60"
              disabled>
        ‚ûï Insert selected
      </button>
      <span id="tplStatus" class="mt-6 text-xs text-gray-500"></span>
    </div>

    <!-- Loaded template items (pick which to insert) -->
    <div id="tplContainer" class="hidden border rounded-md p-3">
      <div class="text-sm font-medium text-gray-700 mb-2">Template items</div>
      <div id="tplList" class="grid grid-cols-1 gap-2"></div>
    </div>

    <ul id="ai-actions-list" class="list-disc pl-6"></ul>

    <div class="flex items-center justify-between">
      <h3 class="text-sm font-medium text-gray-700">Action Plan Items</h3>
      <span id="action-count" class="text-xs text-gray-500">0 items</span>
    </div>

    <div id="action-plan-list" class="mb-2">
      {# Rehydrate any existing items from the session #}
      {% for it in (data.action_plan_items or []) %}
        <div class="flex items-center gap-2 mt-2">
          <input type="text" name="action_plan_items[]" class="form-input flex-1 rounded border px-3 py-2" value="{{ it }}">
          <button type="button" class="px-2 py-1 border rounded hover:bg-gray-50" title="Move up">‚Üë</button>
          <button type="button" class="px-2 py-1 border rounded hover:bg-gray-50" title="Move down">‚Üì</button>
          <button type="button" class="px-2 py-1 border rounded text-red-700 hover:bg-red-50" title="Remove">‚úï</button>
        </div>
      {% endfor %}
    </div>

    <div class="flex flex-wrap gap-3">
      <button type="button" onclick="addActionItem()" class="text-sm text-ellipse-teal hover:underline">+ Add Action Item</button>
      <button type="button" id="ai-suggest-btn" class="text-sm bg-ellipse-teal text-white px-3 py-1 rounded hover:bg-ellipse-hover transition">
        ‚ö° Suggest with AI
      </button>
      <button type="button" id="clear-ai" class="text-sm border px-3 py-1 rounded hover:bg-gray-50 transition">Clear AI results</button>
    </div>

    {% if wizard_errors.action_plan_items %}
      <p class="text-red-600 text-sm mt-1">{{ wizard_errors.action_plan_items }}</p>
    {% endif %}

    <div id="next-up-suggestions" class="hidden mt-6">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-medium text-gray-700">Next Up Suggestions</h3>
        <button type="button" id="insert-selected-nextup" class="text-xs bg-gray-800 text-white px-2 py-1 rounded hover:bg-gray-700">Insert selected</button>
      </div>
      <div id="suggestion-cards" class="grid grid-cols-1 gap-2 mt-2"></div>
      <p class="text-xs text-gray-500 mt-1">Tick items you want to add to the action plan, then click ‚ÄúInsert selected‚Äù.</p>
    </div>
  </div>

  <script>
  (function(){
    const btnLoad = document.getElementById('btnLoadTemplates');
    const btnInsert = document.getElementById('btnInsertTemplates');
    const tplList = document.getElementById('tplList');
    const tplWrap = document.getElementById('tplContainer');
    const tplStatus = document.getElementById('tplStatus');

    function setTplStatus(msg){ if(tplStatus) tplStatus.textContent = msg || ''; }
    function clearTplUI(){
      tplList.innerHTML = '';
      tplWrap.classList.add('hidden');
      btnInsert.disabled = true;
      setTplStatus('');
    }

    btnLoad?.addEventListener('click', async ()=>{
      clearTplUI();
      const cat = (document.getElementById('tpl_category')?.value || '').trim();
      const sev = (document.getElementById('tpl_severity')?.value || '').trim();
      if(!cat){
        setTplStatus('Pick a category in Step 2 to get template suggestions.');
        return;
      }
      setTplStatus('Loading templates‚Ä¶');
      try{
        const res = await fetch(`/taxonomy/action_templates?category=${encodeURIComponent(cat)}&severity=${encodeURIComponent(sev)}`);
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : [];
        if(!items.length){ setTplStatus('No templates available for this selection.'); return; }
        tplWrap.classList.remove('hidden');
        tplList.innerHTML = items.map((t, i)=>`
          <label class="flex items-start gap-2 p-2 border rounded hover:bg-gray-50 cursor-pointer">
            <input type="checkbox" data-idx="${i}" class="mt-1">
            <span class="text-sm text-gray-700">${t.replace(/</g,'&lt;')}</span>
          </label>
        `).join('');
        btnInsert.disabled = false;
        setTplStatus(`${items.length} template item${items.length===1?'':'s'} loaded`);
        // stash on element for quick readback
        tplList.dataset.items = JSON.stringify(items);
      }catch(e){
        setTplStatus('Failed to load templates.');
      }
    });

    btnInsert?.addEventListener('click', ()=>{
      try{
        const items = JSON.parse(tplList.dataset.items || '[]');
        const picked = [];
        tplList.querySelectorAll('input[type="checkbox"]').forEach((cb)=>{
          const idx = parseInt(cb.getAttribute('data-idx')||'-1', 10);
          if(cb.checked && idx>=0 && items[idx]) picked.push(items[idx]);
        });
        if(!picked.length){ setTplStatus('Select at least one template item.'); return; }
        picked.forEach(txt => addActionItem(txt));
        updateActionCount();
        window.__dirty = true;
        if (window.debouncedSave) window.debouncedSave();
        setTplStatus(`${picked.length} item${picked.length===1?'':'s'} inserted`);
      }catch(_){
        setTplStatus('Could not insert items.');
      }
    });
  })();
  </script>

{% elif step == 6 %}
  <div class="space-y-4 text-sm text-gray-700">
    <p><strong>Employee:</strong> {{ data.employee_name or '' }}</p>
    <p><strong>Concerns:</strong> {{ data.concerns }}</p>
    <p><strong>Category:</strong> {{ data.concern_category }}</p>
    <p><strong>Severity:</strong> {{ data.severity }}</p>
    <p><strong>Frequency:</strong> {{ data.frequency }}</p>
    <p><strong>Tags:</strong> {{ data.concern_tags }}</p>
    <p><strong>Start Date:</strong> {{ data.start_date }}</p>
    <p><strong>Review Date:</strong> {{ data.review_date }}</p>
    <p><strong>Meeting Date:</strong> {{ data.capability_meeting_date }}</p>
    <p><strong>Meeting Time:</strong> {{ data.capability_meeting_time }}</p>
    <p><strong>Venue:</strong> {{ data.capability_meeting_venue }}</p>
    <p><strong>Draft Name:</strong> {{ data.draft_name }}</p>

    <div class="pt-2">
      <strong>Action Plan:</strong>
      {% set items = data.action_plan_items or [] %}
      {% if items %}
        <ul class="list-disc pl-5 mt-1">
          {% for it in items %}
            <li>{{ it }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-gray-500">No actions captured.</p>
      {% endif %}
    </div>
  </div>
{% endif %}


    <!-- Navigation Buttons -->
    <div class="mt-8 flex flex-wrap justify-between items-center gap-4">
      {% if step > 1 %}
        <a href="{{ url_for('create_pip_wizard', goto=step-1) }}" class="text-sm text-ellipse-teal hover:underline font-medium" rel="prev">‚Üê Back</a>
      {% else %}<div></div>{% endif %}

        <div class="flex items-center gap-3">
          <!-- NEXT / SUBMIT (button logic updated) -->
          <button id="nextBtn" type="button"
            class="relative inline-flex items-center gap-2 bg-ellipse-teal text-white px-4 py-2 rounded shadow hover:bg-ellipse-hover transition disabled:opacity-70 disabled:cursor-not-allowed">
            <svg class="next-spinner hidden absolute left-3 h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a 8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <span class="next-label">{% if step == 6 %}Submit{% elif step == 5 %}Next: Review{% else %}Next{% endif %}</span>
          </button>

          <button type="button" onclick="saveDraft()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300 transition">
            üíæ Save Draft
          </button>
        </div>
      </div>
    </div>
    <div class="h-16"></div>
  </form>

  <!-- Quick-Add Employee Modal -->
  <div id="quickAddModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="qaTitle">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 border border-gray-200" tabindex="-1">
      <h2 id="qaTitle" class="text-xl font-semibold mb-4 text-[#005b5a]">Quick Add Employee</h2>
      <form id="quickAddForm" class="space-y-4">
        <div>
          <label class="block font-medium text-gray-700">First Name</label>
          <input type="text" name="first_name" class="border border-gray-300 rounded-lg w-full p-2 focus:outline-none focus:ring-2 focus:ring-[#005b5a]" required>
        </div>
        <div>
          <label class="block font-medium text-gray-700">Last Name</label>
          <input type="text" name="last_name" class="border border-gray-300 rounded-lg w-full p-2 focus:outline-none focus:ring-2 focus:ring-[#005b5a]" required>
        </div>
        <div>
          <label class="block font-medium text-gray-700">Role</label>
          <input type="text" name="role" class="border border-gray-300 rounded-lg w-full p-2 focus:outline-none focus:ring-2 focus:ring-[#005b5a]">
        </div>
        <div>
          <label class="block font-medium text-gray-700">Service</label>
          <input type="text" name="service" class="border border-gray-300 rounded-lg w-full p-2 focus:outline-none focus:ring-2 focus:ring-[#005b5a]">
        </div>
        <div class="flex justify-end space-x-2 pt-4">
          <button type="button" id="cancelQuickAdd" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-[#005b5a] text-white rounded-lg hover:bg-[#004746]">Save</button>
        </div>
      </form>
    </div>
  </div>

</div>

<!-- Scripts -->
<script>
/* ===== Helpers ===== */
function debounce(fn, wait) { let t; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), wait); }; }
function _parseTags(str){return (str||'').split(',').map(s=>s.trim()).filter(Boolean);}
function _stringifyTags(arr){const seen=new Set(),out=[];for(const t of arr){const k=t.toLowerCase();if(!seen.has(k)){out.push(t);seen.add(k);}}return out.join(', ');}
function _buildTagChip(tag,checked){const lbl=document.createElement('label');lbl.className='inline-flex items-center space-x-2 px-3 py-1 rounded-full border text-sm cursor-pointer hover:bg-gray-50';const cb=document.createElement('input');cb.type='checkbox';cb.value=tag;cb.checked=!!checked;cb.className='rounded';const span=document.createElement('span');span.textContent=tag;lbl.appendChild(cb);lbl.appendChild(span);return lbl;}
function updateActionCount(){const n=document.querySelectorAll('#action-plan-list input[name="action_plan_items[]"]').length;const el=document.getElementById('action-count');if(el) el.textContent=`${n} item${n===1?'':'s'}`;}
function addActionItem(value=''){const c=document.getElementById("action-plan-list");if(!c)return;const row=document.createElement('div');row.className='flex items-center gap-2 mt-2';const input=document.createElement('input');input.type='text';input.name='action_plan_items[]';input.className='form-input flex-1 rounded border px-3 py-2';input.placeholder='Enter action item';input.value=value||'';const up=document.createElement('button');up.type='button';up.title='Move up';up.className='px-2 py-1 border rounded hover:bg-gray-50';up.textContent='‚Üë';up.onclick=()=>{const p=row.previousElementSibling;if(p)c.insertBefore(row,p);debouncedSave();};const down=document.createElement('button');down.type='button';down.title='Move down';down.className='px-2 py-1 border rounded hover:bg-gray-50';down.textContent='‚Üì';down.onclick=()=>{const n=row.nextElementSibling;if(n)c.insertBefore(n,row);debouncedSave();};const del=document.createElement('button');del.type='button';del.title='Remove';del.className='px-2 py-1 border rounded text-red-700 hover:bg-red-50';del.textContent='‚úï';del.onclick=()=>{row.remove();updateActionCount();debouncedSave();};row.appendChild(input);row.appendChild(up);row.appendChild(down);row.appendChild(del);c.appendChild(row);updateActionCount();}
function addActionItemsBulk(items=[]){items.forEach(txt=>addActionItem(txt));}
function buildNextUpCard(text,checked=false){const card=document.createElement('label');card.className='flex items-start gap-2 p-2 border rounded hover:bg-gray-50 cursor-pointer';const cb=document.createElement('input');cb.type='checkbox';cb.className='mt-1';cb.checked=!!checked;const span=document.createElement('span');span.className='text-sm text-gray-700';span.textContent=text;card.appendChild(cb);card.appendChild(span);return {card,cb,span};}

/* ===== DOM Wiring ===== */
document.addEventListener('DOMContentLoaded', () => {
  // Debounced autosave
  window.debouncedSave = debounce(() => saveDraft(), 800);
  ['draft_name','employee_id','concerns','concern_category','concern_tags','severity','frequency','start_date','review_weeks','review_date','meeting_date','meeting_time','meeting_venue']
    .forEach(id=>{const el=document.getElementById(id); el?.addEventListener('input',()=>{window.__dirty=true;debouncedSave();}); el?.addEventListener('change',()=>{window.__dirty=true;debouncedSave();});});
  const actionList=document.getElementById('action-plan-list');
  actionList?.addEventListener('input',debouncedSave);
  actionList?.addEventListener('click',(e)=>{if(e.target.tagName==='BUTTON') debouncedSave();});

  // Clickable stepper (validate+save on forward; save-only on back)
  const currentStep = {{ step | int }};
  document.querySelectorAll('.wizard-step').forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      const enabled = btn.dataset.enabled === '1';
      const target = parseInt(btn.dataset.step||'0',10);
      if (!enabled || target === currentStep) { ev.preventDefault(); return; }
      const go = ()=>{
        window.__navigating = true;   // ‚úÖ suppress beforeunload
        window.__dirty = false;       // optional: avoid flicker if save was noop
        window.location = '{{ url_for("create_pip_wizard") }}?goto=' + target;
    };

      if (target > currentStep) {
        ev.preventDefault();
        validateStep(currentStep, function(valid){
          if (valid) saveDraft(go);
        });
      } else {
        ev.preventDefault();
        saveDraft(go);
      }
    });
  });

  // Mirrors (Step 4)
  const d=document.getElementById('meeting_date'), t=document.getElementById('meeting_time');
  const dM=document.getElementById('meeting_date_mirror'), tM=document.getElementById('meeting_time_mirror');
  d?.addEventListener('input',()=>{ if(dM) dM.value=d.value; });
  t?.addEventListener('input',()=>{ if(tM) tM.value=t.value; });

  // Taxonomy + suggested tags
  const catSel=document.querySelector('#concern_category');
  if(catSel && !catSel.dataset.loaded){
    fetch('/taxonomy/categories').then(r=>r.json()).then(({categories})=>{
      if(!categories) return;
      const cur=catSel.value;
      catSel.innerHTML='<option value="">-- Select Category --</option>'+categories.map(c=>`<option value="${c}">${c}</option>`).join('');
      if(cur) catSel.value=cur; catSel.dataset.loaded='1';
    }).catch(()=>{});
  }
  const tagInput2=document.querySelector('#concern_tags');
  const suggWrap=document.querySelector('#suggested-tags');
  async function loadSuggestedTags(){
    if(!suggWrap) return;
    const category=(catSel?.value||'').trim();
    const res=await fetch(`/taxonomy/tags_suggest?category=${encodeURIComponent(category)}&q=`);
    const data=await res.json();
    const current=_parseTags(tagInput2?.value||'');
    suggWrap.innerHTML='';
    (data.tags||[]).forEach(tg=>{
      const checked=current.map(x=>x.toLowerCase()).includes(tg.toLowerCase());
      const chip=_buildTagChip(tg,checked);
      chip.querySelector('input[type="checkbox"]').addEventListener('change',(e)=>{
        const list=_parseTags(tagInput2.value);
        const idx=list.findIndex(x=>x.toLowerCase()===tg.toLowerCase());
        if(e.target.checked){ if(idx===-1) list.push(tg); } else { if(idx!==-1) list.splice(idx,1); }
        tagInput2.value=_stringifyTags(list); window.__dirty=true; debouncedSave();
      });
      suggWrap.appendChild(chip);
    });
  }
  catSel?.addEventListener('change',()=>{loadSuggestedTags();window.__dirty=true;debouncedSave();});
  let syncTimer=null;
  tagInput2?.addEventListener('input',()=>{clearTimeout(syncTimer);syncTimer=setTimeout(()=>{const cur=_parseTags(tagInput2.value);const lowers=cur.map(x=>x.toLowerCase());suggWrap?.querySelectorAll('input[type="checkbox"]').forEach(cb=>{cb.checked=lowers.includes(cb.value.toLowerCase());});window.__dirty=true;debouncedSave();},150);});
  if(suggWrap) loadSuggestedTags();

  // Typeahead
  const tagInput=document.querySelector('#concern_tags'); let tagTimer=null; const suggBox=document.createElement('div');
  if(tagInput && tagInput.parentNode){
    suggBox.className='tags-suggest-box'; Object.assign(suggBox.style,{position:'absolute',zIndex:10,display:'none'});
    tagInput.parentNode.style.position='relative'; tagInput.parentNode.appendChild(suggBox);
    function showTagSuggestions(q){
      fetch('/taxonomy/tags_suggest?q='+encodeURIComponent(q||'')+'&category='+encodeURIComponent(catSel?.value||''))
        .then(r=>r.json()).then(({tags})=>{
          if(!tags||!tags.length){suggBox.style.display='none';return;}
          suggBox.innerHTML=tags.map(t=>`<div class="px-2 py-1 hover:bg-gray-100 cursor-pointer">${t}</div>`).join('');
          Object.assign(suggBox.style,{left:tagInput.offsetLeft+'px',top:(tagInput.offsetTop+tagInput.offsetHeight)+'px',width:tagInput.offsetWidth+'px',display:'block'});
          Array.from(suggBox.children).forEach(el=>{
            el.onclick=()=>{const picked=el.textContent.trim();const existing=(tagInput.value||'').split(',').map(x=>x.trim()).filter(Boolean);if(!existing.map(x=>x.toLowerCase()).includes(picked.toLowerCase())) existing.push(picked);tagInput.value=_stringifyTags(existing);suggBox.style.display='none';tagInput.focus();window.__dirty=true;debouncedSave();};
          });
        }).catch(()=>{suggBox.style.display='none';});
    }
    tagInput.addEventListener('input',()=>{clearTimeout(tagTimer);const last=(tagInput.value||'').split(',').pop().trim();tagTimer=setTimeout(()=>showTagSuggestions(last),200);});
    document.addEventListener('click',e=>{if(!suggBox.contains(e.target)&&e.target!==tagInput){suggBox.style.display='none';}});
  }

  // AI suggestions
  const aiBtn=document.querySelector('#ai-suggest-btn');
  const aiLabel=aiBtn?.querySelector('.ai-label');
  const aiSpin=aiBtn?.querySelector('.ai-spinner');
  const aiList=document.querySelector('#ai-actions-list');
  const clearAI=document.querySelector('#clear-ai');
  const nextWrap=document.getElementById('next-up-suggestions');
  const cards=document.getElementById('suggestion-cards');

  function setAIState(loading){ if(!aiBtn) return; aiBtn.disabled=!!loading; aiBtn.setAttribute('aria-busy',loading?'true':'false'); aiSpin?.classList.toggle('hidden',!loading); if(aiLabel) aiLabel.textContent=loading?'Thinking‚Ä¶':'‚ö° Suggest with AI'; }

  aiBtn?.addEventListener('click', async (e)=>{
    e.preventDefault(); setAIState(true); if(aiList) aiList.innerHTML='';
    const payload={concerns:(document.querySelector('#concerns')?.value||'').trim(),category:(document.querySelector('#concern_category')?.value||'').trim(),severity:(document.querySelector('#severity')?.value||'').trim(),frequency:(document.querySelector('#frequency')?.value||'').trim(),tags:(document.querySelector('#concern_tags')?.value||'').trim()};
    try{
      const csrf=document.querySelector('[name="csrf_token"]')?.value;
      const res=await fetch('{{ url_for("suggest_actions_ai") }}',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrf},body:JSON.stringify(payload)});
      const data=await res.json();
      const actions=Array.isArray(data.actions)?data.actions:[]; aiList?.replaceChildren();
      if(actions.length){ actions.forEach(a=>{const li=document.createElement('li'); li.textContent=a; li.className='py-1'; aiList?.appendChild(li);}); addActionItemsBulk(actions); debouncedSave(); }
      else if(aiList){ const li=document.createElement('li'); li.textContent='No suggestions returned.'; li.className='text-gray-500'; aiList.appendChild(li); }
      if(cards && nextWrap){ cards.innerHTML=''; const nexts=Array.isArray(data.next_up)?data.next_up:[]; if(nexts.length){ nextWrap.classList.remove('hidden'); nexts.forEach(t=>{const {card}=buildNextUpCard(t,false); cards.appendChild(card);}); } else { nextWrap.classList.add('hidden'); } }
    }catch(err){
      if(aiList){ const li=document.createElement('li'); li.textContent='Could not fetch suggestions.'; li.className='text-red-600'; aiList.appendChild(li); }
    }finally{ aiBtn.disabled=false; aiBtn.textContent='‚ö° Suggest with AI'; updateActionCount(); }
  });
  clearAI?.addEventListener('click',()=>{ if(aiList) aiList.innerHTML=''; });

  document.getElementById('insert-selected-nextup')?.addEventListener('click',()=>{
    if(!cards)return; const picked=[];
    cards.querySelectorAll('label').forEach(lbl=>{
      const cb=lbl.querySelector('input[type="checkbox"]');
      const text=lbl.querySelector('span')?.textContent||'';
      if(cb?.checked && text) picked.push(text);
    });
    if(picked.length){ addActionItemsBulk(picked); cards.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false); updateActionCount(); debouncedSave(); }
  });
});

/* ===== Save Draft / Validation / Next ===== */
window.saveDraft = function(callback){
  const form = document.getElementById("wizardForm"); 
  if (!form) return;
  const formData = new FormData(form);
  fetch("{{ url_for('save_pip_draft') }}", { method:"POST", body: formData })
    .then(res => res.json()).then(() => {
      const status = document.getElementById("autosave-status");
      if (status) status.innerText = `Last saved: ${new Date().toLocaleTimeString()}`;
      // ‚úÖ consider the page "clean" after we save successfully
      window.__dirty = false;
      if (callback) callback();
    })
    .catch(() => { alert("Failed to save draft."); });
};
function validateStep(step,callback){
  const form=document.getElementById("wizardForm"); if(!form){callback(false);return;}
  const formData=new FormData(form); formData.append("step",step);
  fetch("{{ url_for('validate_wizard_step') }}",{method:"POST",body:formData})
    .then(r=>r.json()).then(data=>{
      document.querySelectorAll(".wizard-error").forEach(el=>el.remove());
      if(!data.success && data.errors){
        for(const field in data.errors){
          const input=document.querySelector(`[name="${field}"]`);
          if(input){
            const p=document.createElement("p");
            p.className="wizard-error text-red-600 text-sm mt-1";
            p.textContent=data.errors[field];
            input.insertAdjacentElement("afterend",p);
          }
        }
      }
      callback(data.success);
    }).catch(()=>callback(false));
}
const currentStep={{ step | int }};
document.getElementById("nextBtn")?.addEventListener("click", function(e){
  e.preventDefault();
  validateStep(currentStep, function(valid){
    if (!valid) return;
    saveDraft(function(){
      window.__navigating = true;   // ‚úÖ intentional nav
      window.__dirty = false;
      document.getElementById("wizardForm").submit();
    });
  });
});


/* Quick-Add modal */
document.addEventListener("DOMContentLoaded",()=>{
  const modal=document.getElementById("quickAddModal");
  const openBtn=document.getElementById("openQuickAdd");
  const cancelBtn=document.getElementById("cancelQuickAdd");
  const form=document.getElementById("quickAddForm");
  const employeeSelect=document.getElementById("employee_id");

  openBtn?.addEventListener("click",()=>{modal.classList.remove("hidden"); modal.classList.add("flex");});
  cancelBtn?.addEventListener("click",()=>{modal.classList.add("hidden"); modal.classList.remove("flex");});

  form?.addEventListener("submit",async(e)=>{
    e.preventDefault();
    const formData=Object.fromEntries(new FormData(form).entries());
    try{
      const res=await fetch("{{ url_for('quick_add_employee') }}",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(formData)});
      const data=await res.json();
      if(data.success){
        const opt=document.createElement("option");
        opt.value=data.id; opt.textContent=data.display_name; opt.selected=true;
        employeeSelect.appendChild(opt);
        const hiddenName=document.getElementById('employee_name');
        if(hiddenName) hiddenName.value=data.display_name;
        form.reset(); modal.classList.add("hidden"); modal.classList.remove("flex");
        const toast=document.createElement("div");
        toast.textContent="‚úÖ Employee added successfully";
        toast.className="fixed bottom-4 right-4 bg-[#005b5a] text-white py-2 px-4 rounded-lg shadow-lg";
        document.body.appendChild(toast); setTimeout(()=>toast.remove(),3000);
        debouncedSave();
      } else {
        alert(data.error || "Error adding employee");
      }
    }catch(err){
      alert("Failed to add employee");
    }
  });
});

// Unload guard
// --- put this near the top of your big <script> block or before other handlers ---
window.__dirty = window.__dirty || false;
window.__navigating = false;

// Only warn if user has unsaved edits AND we are not doing an intentional nav.
window.addEventListener('beforeunload', (e) => {
  if (window.__navigating) return;
  if (!window.__dirty) return;
  e.preventDefault();
  e.returnValue = '';
});

// Pull employee fields if needed (final step safety)
function hydrateFinalHiddenFields(){
  const eid=document.querySelector('input[name="employee_id"]');
  const ename=document.querySelector('input[name="employee_name"]');

  const sel=document.getElementById('employee_id');
  if(sel){
    if(eid && !eid.value) eid.value=sel.value||'';
    if(ename && !ename.value) ename.value=sel.options[sel.selectedIndex]?.text?.trim()||'';
  }

  const keys=['pipWizardLocal','pip_wizard_local','pip_draft','pipDraft'];
  for(const k of keys){
    try{
      const raw=localStorage.getItem(k); if(!raw) continue;
      const obj=JSON.parse(raw);
      if(eid && !eid.value && (obj.employee_id || obj.employeeId)){ eid.value=obj.employee_id || obj.employeeId; }
      if(ename && !ename.value && (obj.employee_name || obj.employeeName)){ ename.value=obj.employee_name || obj.employeeName; }
      if(eid?.value) break;
    }catch(_){}
  }
}
</script>
{% endblock %}
