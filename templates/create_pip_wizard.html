{% extends 'base.html' %}
{% block content %}

{% from "_ui.html" import Button, Field, Input, Select, Textarea, ErrorText, HelpText %}

<div class="max-w-2xl mx-auto py-10 px-6 bg-white shadow-md rounded-md">

  <!-- Autosave & Draft Name -->
  <div class="flex justify-between items-center mb-4 text-sm text-gray-500">
    <div>
      <label for="draft_name" class="font-medium text-gray-700">Draft name:</label>
      <input type="text" name="draft_name" id="draft_name" value="{{ data.draft_name or '' }}" class="ml-2 border rounded px-2 py-1">
    </div>
    <div id="autosave-status">Last saved: just now</div>
  </div>

  {# Compute max-allowed step (server may also pass max_allowed_step) #}
  {% set _max_jinja = 1 %}
  {% if data.employee_id %}{% set _max_jinja = 2 %}{% endif %}
  {% if data.concerns and data.concern_category and data.severity and data.frequency %}{% set _max_jinja = 3 %}{% endif %}
  {% if data.start_date and data.review_date %}{% set _max_jinja = 4 %}{% endif %}
  {% if data.capability_meeting_date and data.capability_meeting_time and data.capability_meeting_venue %}{% set _max_jinja = 6 %}{% endif %}
  {% set allowed = max_allowed_step if max_allowed_step is defined else _max_jinja %}

  <!-- Visual Step Tracker with Icons (clickable up to max_allowed_step) -->
  <div class="flex justify-between items-center mb-6 text-sm font-medium text-gray-500">
    {% set steps = [
      (1, 'üë§ Select Employee'),
      (2, '‚ö†Ô∏è Define Concerns'),
      (3, 'üóìÔ∏è Set Dates'),
      (4, 'üè¢ Schedule Meeting'),
      (5, 'üìù Action Plan'),
      (6, '‚úÖ Review & Submit')
    ] %}

    {% for i, label in steps %}
      {% set _allowed = i <= (max_allowed_step or 1) %}
      {% set is_current = (step == i) %}

      {% if _allowed %}
        <a href="{{ url_for('create_pip_wizard') }}?goto={{ i }}"
           class="flex-1 text-center px-1 transition {% if is_current %}text-ellipse-teal font-bold{% else %}hover:text-ellipse-teal{% endif %}">
          {{ label }}
        </a>
      {% else %}
        <div class="flex-1 text-center px-1 opacity-50 cursor-not-allowed" aria-disabled="true" title="Complete previous steps first">
          {{ label }}
        </div>
      {% endif %}

      {% if not loop.last %}
        <div class="w-5 h-1 mx-1 {% if i < (max_allowed_step or 1) %}bg-ellipse-teal{% else %}bg-gray-300{% endif %}"></div>
      {% endif %}
    {% endfor %}
  </div>

  <form method="POST" id="wizardForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    {% if step == 1 %}
      <div class="mb-4">
        <label for="employee_id" class="block text-gray-700 font-medium">Select Employee:</label>
        <div class="flex items-center space-x-2">
          <select id="employee_id" name="employee_id" class="border border-gray-300 rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-[#005b5a]">
            <option value="">-- Select Employee --</option>
            {% for emp in employees %}
              <option value="{{ emp.id }}" {% if data.employee_id == emp.id %}selected{% endif %}>
                {{ emp.first_name }} {{ emp.last_name }}
              </option>
            {% endfor %}
          </select>
          <button type="button" id="openQuickAdd" class="px-3 py-2 bg-[#005b5a] text-white rounded-lg hover:bg-[#004746]">+ Add</button>
        </div>
        <input type="hidden" name="employee_name" id="employee_name" value="{{ data.employee_name or '' }}">
        {% if wizard_errors.employee_id %}
          <p class="text-red-600 text-sm mt-1">{{ wizard_errors.employee_id }}</p>
        {% endif %}
      </div>

      <script>
        (function () {
          const sel = document.getElementById('employee_id');
          const hidden = document.getElementById('employee_name');
          function setName() {
            const t = sel.options[sel.selectedIndex]?.text || '';
            hidden.value = t;
          }
          sel?.addEventListener('change', setName);
          if (sel && sel.value && !hidden.value) setName();
        })();
      </script>

    {% elif step == 2 %}
<div class="space-y-6">
  {% call Field("Describe Concerns:", "concerns", error=wizard_errors.concerns) %}
    {{ Textarea("concerns", id="concerns", rows=4, value=data.concerns or '', classes="form-textarea mt-1 block w-full rounded-md border-gray-300 shadow-sm") }}
  {% endcall %}

  {% set cat_opts = [('', '-- Select Category --')] + [
      ('Performance','Performance'),
      ('Conduct','Conduct'),
      ('Timekeeping','Timekeeping'),
      ('Absence','Absence'),
      ('Attitude','Attitude'),
      ('Communication','Communication')
  ] %}
  {% call Field("Concern Category:", "concern_category", error=wizard_errors.concern_category) %}
    {{ Select("concern_category", cat_opts, value=data.concern_category or '', id="concern_category", classes="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm") }}
  {% endcall %}

  {% call Field("Concern Tags (comma-separated):", "concern_tags") %}
    {{ Input("concern_tags", value=data.concern_tags or '', id="concern_tags", placeholder="e.g. missed deadlines, attitude", classes="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm") }}
    <div id="suggested-tags" class="mt-3 flex flex-wrap gap-2"></div>
    {{ HelpText("Tip: click tags to add/remove; they sync with the box above.") }}
  {% endcall %}

  {% set severities = [('', '-- Select Severity --'), ('Low','Low'), ('Moderate','Moderate'), ('High','High')] %}
  {% call Field("Severity:", "severity", error=wizard_errors.severity) %}
    {{ Select("severity", severities, value=data.severity or '', id="severity", classes="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm") }}
  {% endcall %}

  {% set freqs = [('', '-- Select Frequency --'), ('One-off','One-off'), ('Occasional','Occasional'), ('Frequent','Frequent'), ('Persistent','Persistent')] %}
  {% call Field("Frequency:", "frequency", error=wizard_errors.frequency) %}
    {{ Select("frequency", freqs, value=data.frequency or '', id="frequency", classes="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm") }}
  {% endcall %}
</div>

{% elif step == 3 %}
  <div class="grid grid-cols-1 gap-4">
    {% call Field("Start Date:", "start_date", error=wizard_errors.start_date) %}
      <input type="date" name="start_date" id="start_date" class="form-input mt-1 block w-full border rounded px-3 py-2" value="{{ data.start_date or '' }}">
    {% endcall %}
    {% call Field("Review Date:", "review_date", error=wizard_errors.review_date) %}
      <input type="date" name="review_date" id="review_date" class="form-input mt-1 block w-full border rounded px-3 py-2" value="{{ data.review_date or '' }}">
    {% endcall %}
  </div>

{% elif step == 4 %}
  <div class="space-y-4">
    {% call Field("Meeting Date:", "meeting_date", error=wizard_errors.meeting_date) %}
      <input type="date" id="meeting_date" name="capability_meeting_date" class="form-input mt-1 block w-full border rounded px-3 py-2" value="{{ data.get('capability_meeting_date','') }}">
    {% endcall %}
    {% call Field("Time:", "meeting_time", error=wizard_errors.meeting_time) %}
      <input type="time" id="meeting_time" name="capability_meeting_time" class="form-input mt-1 block w-full border rounded px-3 py-2" value="{{ data.get('capability_meeting_time','') }}">
    {% endcall %}
    {% call Field("Venue:", "meeting_venue", error=wizard_errors.capability_meeting_venue) %}
      <input type="text" id="meeting_venue" name="capability_meeting_venue" class="form-input mt-1 block w-full border rounded px-3 py-2" value="{{ data.get('capability_meeting_venue','') }}" placeholder="e.g. Conference Room 2A or Teams">
    {% endcall %}
  </div>

  <input type="hidden" name="meeting_date" id="meeting_date_mirror" value="{{ data.get('capability_meeting_date','') }}">
  <input type="hidden" name="meeting_time" id="meeting_time_mirror" value="{{ data.get('capability_meeting_time','') }}">

{% elif step == 5 %}
  <div class="space-y-4">
    <ul id="ai-actions-list" class="list-disc pl-6"></ul>

    <div class="flex items-center justify-between">
      <h3 class="text-sm font-medium text-gray-700">Action Plan Items</h3>
      <span id="action-count" class="text-xs text-gray-500">0 items</span>
    </div>
    <div id="action-plan-list" class="mb-2"></div>

    <div class="flex flex-wrap gap-3 items-center">
      <button type="button" onclick="addActionItem()" class="text-sm text-ellipse-teal hover:underline">+ Add Action Item</button>

      <button
        type="button"
        id="ai-suggest-btn"
        class="relative inline-flex items-center gap-2 text-sm bg-ellipse-teal text-white px-3 py-1 rounded hover:bg-ellipse-hover transition disabled:opacity-70 disabled:cursor-not-allowed"
        aria-live="polite"
        aria-busy="false">
        <svg class="ai-spinner hidden absolute left-2 h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <span class="ai-label">‚ö° Suggest with AI</span>
      </button>

      <button type="button" id="clear-ai" class="text-sm border px-3 py-1 rounded hover:bg-gray-50 transition">Clear AI results</button>
    </div>

    {% if wizard_errors.action_plan_items %}
      <p class="text-red-600 text-sm mt-1">{{ wizard_errors.action_plan_items }}</p>
    {% endif %}

    <div id="next-up-suggestions" class="hidden mt-6">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-medium text-gray-700">Next Up Suggestions</h3>
        <button type="button" id="insert-selected-nextup" class="text-xs bg-gray-800 text-white px-2 py-1 rounded hover:bg-gray-700">Insert selected</button>
      </div>
      <div id="suggestion-cards" class="grid grid-cols-1 gap-2 mt-2"></div>
      <p class="text-xs text-gray-500 mt-1">Tick items you want to add to the action plan, then click ‚ÄúInsert selected‚Äù.</p>
    </div>
  </div>

{% elif step == 6 %}
  {# Hidden mirrors to ensure required values post on submit #}
  <input type="hidden" name="employee_id" value="{{ data.employee_id or '' }}">
  <input type="hidden" name="employee_name" value="{{ data.employee_name or '' }}">
  <input type="hidden" name="concerns" value="{{ data.concerns or '' }}">
  <input type="hidden" name="concern_category" value="{{ data.concern_category or '' }}">
  <input type="hidden" name="severity" value="{{ data.severity or '' }}">
  <input type="hidden" name="frequency" value="{{ data.frequency or '' }}">
  <input type="hidden" name="concern_tags" value="{{ data.concern_tags or '' }}">
  <input type="hidden" name="start_date" value="{{ data.start_date or '' }}">
  <input type="hidden" name="review_date" value="{{ data.review_date or '' }}">
  <input type="hidden" name="meeting_date" value="{{ data.capability_meeting_date or data.meeting_date or '' }}">
  <input type="hidden" name="meeting_time" value="{{ data.capability_meeting_time or data.meeting_time or '' }}">
  <input type="hidden" name="meeting_venue" value="{{ data.capability_meeting_venue or data.meeting_venue or '' }}">
  <input type="hidden" name="capability_meeting_date" value="{{ data.capability_meeting_date or '' }}">
  <input type="hidden" name="capability_meeting_time" value="{{ data.capability_meeting_time or '' }}">
  <input type="hidden" name="capability_meeting_venue" value="{{ data.capability_meeting_venue or '' }}">
  <input type="hidden" name="draft_name" value="{{ data.draft_name or '' }}">

  <div class="space-y-4 text-sm text-gray-700">
    <p><strong>Employee:</strong> {{ data.employee_name or '' }}</p>
    <p><strong>Concerns:</strong> {{ data.concerns }}</p>
    <p><strong>Category:</strong> {{ data.concern_category }}</p>
    <p><strong>Severity:</strong> {{ data.severity }}</p>
    <p><strong>Frequency:</strong> {{ data.frequency }}</p>
    <p><strong>Tags:</strong> {{ data.concern_tags }}</p>
    <p><strong>Start Date:</strong> {{ data.start_date }}</p>
    <p><strong>Review Date:</strong> {{ data.review_date }}</p>
    <p><strong>Meeting Date:</strong> {{ data.capability_meeting_date or data.meeting_date }}</p>
    <p><strong>Meeting Time:</strong> {{ data.capability_meeting_time or data.meeting_time }}</p>
    <p><strong>Venue:</strong> {{ data.capability_meeting_venue or data.meeting_venue }}</p>
    <p><strong>Draft Name:</strong> {{ data.draft_name }}</p>
  </div>
{% endif %}

    <!-- Sticky footer / Navigation -->
    <div class="sticky bottom-0 z-10 bg-white/95 border-t mt-8 py-3">
      <div class="flex flex-wrap justify-between items-center gap-4">
        {% if step > 1 %}
          <a href="{{ url_for('create_pip_wizard', goto=step-1) }}" class="text-sm text-ellipse-teal hover:underline font-medium" rel="prev">‚Üê Back</a>
        {% else %}
          <div></div>
        {% endif %}

        <div class="flex items-center gap-3">
          <!-- NEXT / SUBMIT (button logic updated) -->
          <button id="nextBtn" type="button"
            class="relative inline-flex items-center gap-2 bg-ellipse-teal text-white px-4 py-2 rounded shadow hover:bg-ellipse-hover transition disabled:opacity-70 disabled:cursor-not-allowed">
            <svg class="next-spinner hidden absolute left-3 h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <span class="next-label">{% if step == 6 %}Submit{% elif step == 5 %}Next: Review{% else %}Next{% endif %}</span>
          </button>

          <button type="button" onclick="saveDraft()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300 transition">
            üíæ Save Draft
          </button>
        </div>
      </div>
    </div>
    <div class="h-16"></div>
  </form>

  <!-- Quick-Add Employee Modal -->
  <div id="quickAddModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="qaTitle">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 border border-gray-200" tabindex="-1">
      <h2 id="qaTitle" class="text-xl font-semibold mb-4 text-[#005b5a]">Quick Add Employee</h2>
      <form id="quickAddForm" class="space-y-4">
        <div>
          <label class="block font-medium text-gray-700">First Name</label>
          <input type="text" name="first_name" class="border border-gray-300 rounded-lg w-full p-2 focus:outline-none focus:ring-2 focus:ring-[#005b5a]" required>
        </div>
        <div>
          <label class="block font-medium text-gray-700">Last Name</label>
          <input type="text" name="last_name" class="border border-gray-300 rounded-lg w-full p-2 focus:outline-none focus:ring-2 focus:ring-[#005b5a]" required>
        </div>
        <div>
          <label class="block font-medium text-gray-700">Role</label>
          <input type="text" name="role" class="border border-gray-300 rounded-lg w-full p-2 focus:outline-none focus:ring-2 focus:ring-[#005b5a]">
        </div>
        <div>
          <label class="block font-medium text-gray-700">Service</label>
          <input type="text" name="service" class="border border-gray-300 rounded-lg w-full p-2 focus:outline-none focus:ring-2 focus:ring-[#005b5a]">
        </div>
        <div class="flex justify-end space-x-2 pt-4">
          <button type="button" id="cancelQuickAdd" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-[#005b5a] text-white rounded-lg hover:bg-[#004746]">Save</button>
        </div>
      </form>
    </div>
  </div>

</div>

<!-- Scripts -->
<script>
// Safe server values for JS
const CURRENT_STEP = {{ (step or 1) | int | tojson }};
const BACK_URL = {{ (url_for('create_pip_wizard', goto=step-1) if step and step > 1 else None) | tojson }};

// Helpers
function debounce(fn, wait){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),wait);};}
function _parseTags(str){return (str||'').split(',').map(s=>s.trim()).filter(Boolean);}
function _stringifyTags(arr){const seen=new Set(),out=[];for(const t of arr){const k=t.toLowerCase();if(!seen.has(k)){out.push(t);seen.add(k);}}return out.join(', ');}
function _buildTagChip(tag,checked){const lbl=document.createElement('label');lbl.className='inline-flex items-center space-x-2 px-3 py-1 rounded-full border text-sm cursor-pointer hover:bg-gray-50';const cb=document.createElement('input');cb.type='checkbox';cb.value=tag;cb.checked=!!checked;cb.className='rounded';const span=document.createElement('span');span.textContent=tag;lbl.appendChild(cb);lbl.appendChild(span);return lbl;}
function updateActionCount(){const n=document.querySelectorAll('#action-plan-list input[name="action_plan_items[]"]').length;const el=document.getElementById('action-count');if(el) el.textContent=`${n} item${n===1?'':'s'}`;}
function addActionItem(v=''){const c=document.getElementById("action-plan-list");if(!c)return;const row=document.createElement('div');row.className='flex items-center gap-2 mt-2';const i=document.createElement('input');i.type='text';i.name='action_plan_items[]';i.className='form-input flex-1 rounded border px-3 py-2';i.placeholder='Enter action item';i.value=v||'';const up=document.createElement('button');up.type='button';up.title='Move up';up.className='px-2 py-1 border rounded hover:bg-gray-50';up.textContent='‚Üë';up.onclick=()=>{const p=row.previousElementSibling;if(p)c.insertBefore(row,p);debouncedSave();};const dn=document.createElement('button');dn.type='button';dn.title='Move down';dn.className='px-2 py-1 border rounded hover:bg-gray-50';dn.textContent='‚Üì';dn.onclick=()=>{const n=row.nextElementSibling;if(n)c.insertBefore(n,row);debouncedSave();};const del=document.createElement('button');del.type='button';del.title='Remove';del.className='px-2 py-1 border rounded text-red-700 hover:bg-red-50';del.textContent='‚úï';del.onclick=()=>{row.remove();updateActionCount();debouncedSave();};row.append(i,up,dn,del);c.appendChild(row);updateActionCount();}
function addActionItemsBulk(items=[]){items.forEach(t=>addActionItem(t));}
function buildNextUpCard(text,checked=false){const card=document.createElement('label');card.className='flex items-start gap-2 p-2 border rounded hover:bg-gray-50 cursor-pointer';const cb=document.createElement('input');cb.type='checkbox';cb.className='mt-1';cb.checked=!!checked;const span=document.createElement('span');span.className='text-sm text-gray-700';span.textContent=text;card.append(cb,span);return {card,cb,span};}
window.__dirty=false;

document.addEventListener('DOMContentLoaded', () => {
  window.debouncedSave = debounce(()=>saveDraft(),800);
  ['draft_name','employee_id','concerns','concern_category','concern_tags','severity','frequency','start_date','review_date','meeting_date','meeting_time','meeting_venue']
    .forEach(id=>{const el=document.getElementById(id); el?.addEventListener('input',()=>{window.__dirty=true;debouncedSave();}); el?.addEventListener('change',()=>{window.__dirty=true;debouncedSave();});});
  const actionList=document.getElementById('action-plan-list');
  actionList?.addEventListener('input',()=>{window.__dirty=true;debouncedSave();});
  actionList?.addEventListener('click',e=>{if(e.target.tagName==='BUTTON'){window.__dirty=true;debouncedSave();}});

  // Mirrors (Step 4)
  const d=document.getElementById('meeting_date'), t=document.getElementById('meeting_time');
  const dM=document.getElementById('meeting_date_mirror'), tM=document.getElementById('meeting_time_mirror');
  d?.addEventListener('input',()=>{ if(dM) dM.value=d.value; });
  t?.addEventListener('input',()=>{ if(tM) tM.value=t.value; });

  // Taxonomy + suggested tags
  const catSel=document.querySelector('#concern_category');
  if(catSel && !catSel.dataset.loaded){
    fetch('/taxonomy/categories').then(r=>r.json()).then(({categories})=>{
      if(!categories) return;
      const cur=catSel.value;
      catSel.innerHTML='<option value="">-- Select Category --</option>'+categories.map(c=>`<option value="${c}">${c}</option>`).join('');
      if(cur) catSel.value=cur; catSel.dataset.loaded='1';
    }).catch(()=>{});
  }
  const tagInput2=document.querySelector('#concern_tags');
  const suggWrap=document.querySelector('#suggested-tags');
  async function loadSuggestedTags(){
    if(!suggWrap) return;
    const category=(catSel?.value||'').trim();
    const res=await fetch(`/taxonomy/tags_suggest?category=${encodeURIComponent(category)}&q=`);
    const data=await res.json();
    const current=_parseTags(tagInput2?.value||'');
    suggWrap.innerHTML='';
    (data.tags||[]).forEach(tg=>{
      const checked=current.map(x=>x.toLowerCase()).includes(tg.toLowerCase());
      const chip=_buildTagChip(tg,checked);
      chip.querySelector('input[type="checkbox"]').addEventListener('change',(e)=>{
        const list=_parseTags(tagInput2.value);
        const idx=list.findIndex(x=>x.toLowerCase()===tg.toLowerCase());
        if(e.target.checked){ if(idx===-1) list.push(tg); } else { if(idx!==-1) list.splice(idx,1); }
        tagInput2.value=_stringifyTags(list); window.__dirty=true; debouncedSave();
      });
      suggWrap.appendChild(chip);
    });
  }
  catSel?.addEventListener('change',()=>{loadSuggestedTags();window.__dirty=true;debouncedSave();});
  let syncTimer=null;
  tagInput2?.addEventListener('input',()=>{clearTimeout(syncTimer);syncTimer=setTimeout(()=>{const cur=_parseTags(tagInput2.value);const lowers=cur.map(x=>x.toLowerCase());suggWrap?.querySelectorAll('input[type="checkbox"]').forEach(cb=>{cb.checked=lowers.includes(cb.value.toLowerCase());});window.__dirty=true;debouncedSave();},150);});
  if(suggWrap) loadSuggestedTags();

  // Typeahead
  const tagInput=document.querySelector('#concern_tags'); let tagTimer=null; const suggBox=document.createElement('div');
  if(tagInput && tagInput.parentNode){
    suggBox.className='tags-suggest-box'; Object.assign(suggBox.style,{position:'absolute',zIndex:10,display:'none'});
    tagInput.parentNode.style.position='relative'; tagInput.parentNode.appendChild(suggBox);
    function showTagSuggestions(q){
      fetch('/taxonomy/tags_suggest?q='+encodeURIComponent(q||'')+'&category='+encodeURIComponent(catSel?.value||''))
        .then(r=>r.json()).then(({tags})=>{
          if(!tags||!tags.length){suggBox.style.display='none';return;}
          suggBox.innerHTML=tags.map(t=>`<div class="px-2 py-1 hover:bg-gray-100 cursor-pointer">${t}</div>`).join('');
          Object.assign(suggBox.style,{left:tagInput.offsetLeft+'px',top:(tagInput.offsetTop+tagInput.offsetHeight)+'px',width:tagInput.offsetWidth+'px',display:'block'});
          Array.from(suggBox.children).forEach(el=>{
            el.onclick=()=>{const picked=el.textContent.trim();const existing=(tagInput.value||'').split(',').map(x=>x.trim()).filter(Boolean);if(!existing.map(x=>x.toLowerCase()).includes(picked.toLowerCase())) existing.push(picked);tagInput.value=_stringifyTags(existing);suggBox.style.display='none';tagInput.focus();window.__dirty=true;debouncedSave();};
          });
        }).catch(()=>{suggBox.style.display='none';});
    }
    tagInput.addEventListener('input',()=>{clearTimeout(tagTimer);const last=(tagInput.value||'').split(',').pop().trim();tagTimer=setTimeout(()=>showTagSuggestions(last),200);});
    document.addEventListener('click',e=>{if(!suggBox.contains(e.target)&&e.target!==tagInput){suggBox.style.display='none';}});
  }

  // AI suggestions
  const aiBtn=document.querySelector('#ai-suggest-btn');
  const aiLabel=aiBtn?.querySelector('.ai-label');
  const aiSpin=aiBtn?.querySelector('.ai-spinner');
  const aiList=document.querySelector('#ai-actions-list');
  const clearAI=document.querySelector('#clear-ai');
  const nextWrap=document.getElementById('next-up-suggestions');
  const cards=document.getElementById('suggestion-cards');

  function setAIState(loading){ if(!aiBtn) return; aiBtn.disabled=!!loading; aiBtn.setAttribute('aria-busy',loading?'true':'false'); aiSpin?.classList.toggle('hidden',!loading); if(aiLabel) aiLabel.textContent=loading?'Thinking‚Ä¶':'‚ö° Suggest with AI'; }

  aiBtn?.addEventListener('click', async (e)=>{
    e.preventDefault(); setAIState(true); if(aiList) aiList.innerHTML='';
    const payload={concerns:(document.querySelector('#concerns')?.value||'').trim(),category:(document.querySelector('#concern_category')?.value||'').trim(),severity:(document.querySelector('#severity')?.value||'').trim(),frequency:(document.querySelector('#frequency')?.value||'').trim(),tags:(document.querySelector('#concern_tags')?.value||'').trim()};
    try{
      const csrf=document.querySelector('[name="csrf_token"]')?.value;
      const res=await fetch('{{ url_for("suggest_actions_ai") }}',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrf},body:JSON.stringify(payload)});
      const data=await res.json();
      const actions=Array.isArray(data.actions)?data.actions:[];
      if(actions.length){actions.forEach(a=>{const li=document.createElement('li');li.textContent=a;li.className='py-1';aiList?.appendChild(li);});addActionItemsBulk(actions);window.__dirty=true;debouncedSave();}
      else if(aiList){const li=document.createElement('li');li.textContent='No suggestions returned.';li.className='text-gray-500';aiList.appendChild(li);}
      if(cards && nextWrap){cards.innerHTML='';const nexts=Array.isArray(data.next_up)?data.next_up:[];if(nexts.length){nextWrap.classList.remove('hidden');nexts.forEach(t=>{const {card}=buildNextUpCard(t,false);cards.appendChild(card);});}else{nextWrap.classList.add('hidden');}}
    }catch(_){ if(aiList){const li=document.createElement('li');li.textContent='Could not fetch suggestions.';li.className='text-red-600';aiList.appendChild(li);} }
    finally{ setAIState(false); updateActionCount(); }
  });
  clearAI?.addEventListener('click',()=>{ if(aiList) aiList.innerHTML=''; });

  document.getElementById('insert-selected-nextup')?.addEventListener('click',()=>{
    if(!cards)return;const picked=[];cards.querySelectorAll('label').forEach(lbl=>{const cb=lbl.querySelector('input[type="checkbox"]');const text=lbl.querySelector('span')?.textContent||'';if(cb?.checked && text)picked.push(text);});if(picked.length){addActionItemsBulk(picked);cards.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);updateActionCount();window.__dirty=true;debouncedSave();}
  });

  // Quick-Add modal (focus trap)
  (function(){
    const modal=document.getElementById('quickAddModal');
    const openBtn=document.getElementById('openQuickAdd');
    const cancelBtn=document.getElementById('cancelQuickAdd');
    const panel=modal?.querySelector('[tabindex="-1"]');
    let lastActive=null;
    function trap(e){
      if(!modal || modal.classList.contains('hidden')) return;
      const f=modal.querySelectorAll('a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])');
      const first=f[0], last=f[f.length-1];
      if(e.key==='Tab'){
        if(e.shiftKey && document.activeElement===first){e.preventDefault();last.focus();}
        else if(!e.shiftKey && document.activeElement===last){e.preventDefault();first.focus();}
      } else if(e.key==='Escape'){ close(); }
    }
    function open(){ lastActive=document.activeElement; modal.classList.remove('hidden'); modal.classList.add('flex'); panel?.focus(); document.addEventListener('keydown',trap); }
    function close(){ modal.classList.add('hidden'); modal.classList.remove('flex'); document.removeEventListener('keydown',trap); lastActive?.focus(); }
    openBtn?.addEventListener('click',open);
    cancelBtn?.addEventListener('click',close);
    modal?.addEventListener('click',e=>{ if(e.target===modal) close(); });
  })();

  // Quick-Add submit
  const qaForm=document.getElementById("quickAddForm");
  const employeeSelect=document.getElementById("employee_id");
  qaForm?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const formData=Object.fromEntries(new FormData(qaForm).entries());
    try{
      const res=await fetch("{{ url_for('quick_add_employee') }}",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(formData)});
      const data=await res.json();
      if(data.success){
        const opt=document.createElement("option"); opt.value=data.id; opt.textContent=data.display_name; opt.selected=true; employeeSelect.appendChild(opt);
        const hiddenName=document.getElementById('employee_name'); if(hiddenName) hiddenName.value=data.display_name;
        qaForm.reset(); document.getElementById('cancelQuickAdd')?.click();
        const toast=document.createElement("div"); toast.textContent="‚úÖ Employee added successfully"; toast.className="fixed bottom-4 right-4 bg-[#005b5a] text-white py-2 px-4 rounded-lg shadow-lg"; document.body.appendChild(toast); setTimeout(()=>toast.remove(),3000);
        window.__dirty=true; debouncedSave();
      } else { alert(data.error || "Error adding employee"); }
    }catch(_){ alert("Failed to add employee"); }
  });

  // Keyboard shortcuts
  document.addEventListener('keydown',(e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveDraft(()=>{const t=document.createElement("div");t.textContent="üíæ Draft saved";t.className="fixed bottom-4 right-4 bg-[#005b5a] text-white py-2 px-3 rounded shadow";document.body.appendChild(t);setTimeout(()=>t.remove(),1600);}); return; }
    if(((e.ctrlKey||e.metaKey) && e.key==='Enter') || (e.altKey && e.key==='ArrowRight')){ e.preventDefault(); document.getElementById('nextBtn')?.click(); return; }
    if(e.altKey && e.key==='ArrowLeft' && BACK_URL){ e.preventDefault(); saveDraft(()=>{window.location=BACK_URL;}); return; }
  });
});

// Save Draft
window.saveDraft=function(cb){
  const form=document.getElementById("wizardForm"); if(!form) return;
  const formData=new FormData(form);
  fetch("{{ url_for('save_pip_draft') }}",{method:"POST",body:formData})
    .then(res=>res.json()).then(()=>{const s=document.getElementById("autosave-status"); if(s) s.innerText=`Last saved: ${new Date().toLocaleTimeString()}`; if(cb) cb();})
    .catch(()=>{alert("Failed to save draft.");});
};
(function(){const orig=window.saveDraft; window.saveDraft=function(){window.__dirty=false; return orig.apply(this,arguments);} })();

// Validation
function validateStep(step,cb){
  const form=document.getElementById("wizardForm"); if(!form){cb(false);return;}
  const formData=new FormData(form); formData.append("step",step);
  fetch("{{ url_for('validate_wizard_step') }}",{method:"POST",body:formData})
    .then(r=>r.json()).then(data=>{
      document.querySelectorAll(".wizard-error").forEach(el=>el.remove());
      let first=null;
      if(!data.success && data.errors){
        for(const field in data.errors){
          const input=document.querySelector(`[name="${field}"]`);
          if(input && !first) first=input;
          if(input){
            const p=document.createElement("p");
            p.className="wizard-error text-red-600 text-sm mt-1";
            p.textContent=data.errors[field];
            input.insertAdjacentElement("afterend",p);
          }
        }
      }
      if(!data.success && first){ first.focus(); try{first.scrollIntoView({behavior:'smooth',block:'center'});}catch(_){}} 
      cb(data.success);
    }).catch(()=>cb(false));
}

// ===== Button logic (only change) =====
document.getElementById("nextBtn")?.addEventListener("click",function(e){
  e.preventDefault();
  const btn=this, spin=btn.querySelector('.next-spinner');
  btn.disabled=true; spin?.classList.remove('hidden');

  if(CURRENT_STEP===6){
    hydrateFinalHiddenFields();
    const eid=(document.querySelector('input[name="employee_id"]')?.value||'').trim();
    if(!eid){
      let msg=document.getElementById('final-missing-employee');
      if(!msg){
        msg=document.createElement('div');
        msg.id='final-missing-employee';
        msg.className='text-red-600 text-sm my-2';
        msg.textContent='Please go back to Step 1 and choose an employee before submitting.';
        document.getElementById('wizardForm')?.insertAdjacentElement('afterbegin',msg);
      }
      try{window.scrollTo({top:0,behavior:'smooth'});}catch(_){}
      btn.disabled=false; spin?.classList.add('hidden');
      return;
    }
  }

  validateStep(CURRENT_STEP,function(valid){
    if(valid){
      window.__dirty=false;
      saveDraft(()=>{ document.getElementById("wizardForm").submit(); });
    } else {
      btn.disabled=false; spin?.classList.add('hidden');
    }
  });
});

// Unload guard
window.addEventListener('beforeunload', (e)=>{ if(!window.__dirty) return; e.preventDefault(); e.returnValue=''; });

// Pull employee fields if needed (final step safety)
function hydrateFinalHiddenFields(){
  const eid=document.querySelector('input[name="employee_id"]');
  const ename=document.querySelector('input[name="employee_name"]');

  const sel=document.getElementById('employee_id');
  if(sel){
    if(eid && !eid.value) eid.value=sel.value||'';
    if(ename && !ename.value) ename.value=sel.options[sel.selectedIndex]?.text?.trim()||'';
  }

  const keys=['pipWizardLocal','pip_wizard_local','pip_draft','pipDraft'];
  for(const k of keys){
    try{
      const raw=localStorage.getItem(k); if(!raw) continue;
      const obj=JSON.parse(raw);
      if(eid && !eid.value && (obj.employee_id || obj.employeeId)){ eid.value=obj.employee_id || obj.employeeId; }
      if(ename && !ename.value && (obj.employee_name || obj.employeeName)){ ename.value=obj.employee_name || obj.employeeName; }
      if(eid?.value) break;
    }catch(_){}
  }
}
</script>
{% endblock %}
