{% extends 'base.html' %}
{% block title %}PIP for {{ employee.first_name }} {{ employee.last_name }}{% endblock %}
{% block page_title %}ğŸ“„ PIP Record{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-6 max-w-7xl mx-auto">

  <!-- Main PIP details -->
  <div class="flex-1">
    <div class="bg-[#e6f3f3] shadow rounded-2xl p-4 sm:p-6 border border-gray-200 space-y-5">

      <h1 class="text-xl sm:text-2xl font-bold text-[#005b5a]">
        PIP for {{ employee.first_name }} {{ employee.last_name }}
      </h1>

      <div class="text-sm text-gray-700 space-y-2">
        <p><strong>Job Title:</strong> {{ employee.job_title }}</p>
        <p><strong>Line Manager:</strong> {{ employee.line_manager }}</p>
        <p><strong>Service:</strong> {{ employee.service }}</p>
        <p><strong>Status:</strong>
          {% if pip.status == 'Open' %}
            <span class="inline-block px-3 py-1 text-xs font-semibold text-white bg-yellow-500 rounded-full">Open</span>
          {% elif pip.status == 'Completed' %}
            <span class="inline-block px-3 py-1 text-xs font-semibold text-white bg-green-600 rounded-full">Completed</span>
          {% elif pip.status == 'Overdue' %}
            <span class="inline-block px-3 py-1 text-xs font-semibold text-white bg-red-600 rounded-full">Overdue</span>
          {% else %}
            <span class="inline-block px-3 py-1 text-xs font-semibold text-white bg-gray-400 rounded-full">{{ pip.status }}</span>
          {% endif %}
        </p>

        <p><strong>Start Date:</strong> {{ pip.start_date.strftime('%d %b %Y') }}</p>
        <p><strong>Review Date:</strong> {{ pip.review_date.strftime('%d %b %Y') }}</p>

        <p><strong>Concerns:</strong><br>{{ pip.concerns }}</p>

        <!-- NEW: Concern taxonomy & tags -->
        <div class="pt-1">
          <p class="text-sm">
            <strong>Category:</strong> {{ pip.concern_category or 'â€”' }}
            &nbsp;Â·&nbsp; <strong>Severity:</strong> {{ pip.severity or 'â€”' }}
            &nbsp;Â·&nbsp; <strong>Frequency:</strong> {{ pip.frequency or 'â€”' }}
          </p>
          {% if pip.tags %}
            <div class="mt-2 flex flex-wrap gap-2">
              {% for t in pip.tags.split(',') %}
                {% set tg = t.strip() %}
                {% if tg %}
                <span class="px-2 py-0.5 text-xs rounded-full border border-gray-300 bg-white text-gray-700">{{ tg }}</span>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <p class="pt-2"><strong>Meeting Notes:</strong><br>{{ pip.meeting_notes or 'â€”' }}</p>
        <p><strong>Meeting Date:</strong> {{ pip.capability_meeting_date.strftime('%d %b %Y') if pip.capability_meeting_date else 'â€”' }}</p>
        <p><strong>Meeting Time:</strong> {{ pip.capability_meeting_time or 'â€”' }}</p>
        <p><strong>Meeting Venue:</strong> {{ pip.capability_meeting_venue or 'â€”' }}</p>
      </div>

      <div>
        <strong class="block text-sm text-gray-700 mb-1">Action Plan:</strong>
        {% if pip.action_items %}
          <ul class="list-disc pl-4 sm:pl-6 mt-2 text-sm text-gray-800 space-y-1">
            {% for action in pip.action_items %}
              <li>
                {{ action.description }}
                {% if action.status %}
                  <span class="text-xs text-gray-500">[{{ action.status }}]</span>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-sm text-gray-500">No actions recorded.</p>
        {% endif %}
      </div>

      <div class="pt-4 flex flex-col sm:flex-row gap-3 sm:items-center">
        <a href="{{ url_for('edit_pip', id=pip.id) }}"
           class="bg-[#005b5a] text-white px-4 py-2 rounded-lg hover:bg-[#007876] transition font-semibold text-sm text-center">
          âœï¸ Edit PIP
        </a>
        <a href="{{ url_for('employee_detail', employee_id=employee.id) }}"
           class="text-sm text-[#005b5a] hover:underline text-center sm:text-left">
          â† Back to Employee
        </a>
      </div>

      <!-- AI Advice block (kept in main column so it's prominent) -->
      <div class="mt-2 p-4 bg-white border border-gray-200 rounded-xl shadow-sm">
        <div class="flex items-center justify-between">
          <h3 class="text-md font-semibold text-[#005b5a]">ğŸ’¬ AI Advice</h3>
          <div class="flex items-center gap-2">
            {% if pip.ai_advice %}
            <button type="button"
                    class="text-xs px-2 py-1 rounded border border-gray-300 hover:bg-gray-50"
                    onclick="copyAdvice()">
              Copy
            </button>
            {% endif %}
            <button type="button"
                    class="text-xs px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700"
                    onclick="openModal()">
              {% if pip.ai_advice %}ğŸ” Regenerate{% else %}ğŸ’¡ Generate{% endif %}
            </button>
          </div>
        </div>

        {% if pip.ai_advice %}
          <pre id="aiAdviceText" class="whitespace-pre-wrap text-sm text-gray-800 mt-3">{{ pip.ai_advice }}</pre>
          <p class="text-xs text-gray-500 italic mt-2">
            Generated on {{ pip.ai_advice_generated_at.strftime('%d %b %Y at %H:%M') if pip.ai_advice_generated_at }}
          </p>
        {% else %}
          <p class="text-sm text-gray-600 mt-2">
            No AI advice generated yet. Use <strong>Generate</strong> to create tailored guidance from the PIP details.
          </p>
        {% endif %}
      </div>

    </div>
  </div>

  <!-- Document Actions + AI -->
  <aside class="lg:w-1/3 bg-[#e6f3f3] border border-gray-200 shadow rounded-2xl p-4 sm:p-6 space-y-4">
    <h2 class="text-lg font-semibold text-[#005b5a]">Generate Documents</h2>

    <a href="{{ url_for('generate_invite_letter', id=pip.id) }}"
       class="block w-full text-center bg-[#005b5a] text-white py-2 rounded hover:bg-[#007876] transition text-sm font-medium">
      ğŸ“„ Create Invite Letter
    </a>
    <a href="{{ url_for('generate_plan_document', id=pip.id) }}"
       class="block w-full text-center bg-green-600 text-white py-2 rounded hover:bg-green-700 transition text-sm font-medium">
      ğŸ“ Create Plan
    </a>
    <a href="{{ url_for('generate_outcome_letter', id=pip.id) }}"
       class="block w-full text-center bg-purple-600 text-white py-2 rounded hover:bg-purple-700 transition text-sm font-medium">
      âœ… Create Outcome Letter
    </a>

    <p class="text-xs text-gray-600">
      These Word docs automatically include the PIP details. The <strong>Plan</strong> also includes your
      <em>Action Plan</em> and (if present) the <em>AI Advice</em> section.
    </p>
  </aside>
</div>

<!-- Modal -->
<div id="aiModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl shadow-xl max-w-md w-full space-y-4 mx-2">
    <h2 class="text-xl font-bold text-[#005b5a]">Are you sure?</h2>
    <p class="text-sm text-gray-700">
      {% if pip.ai_advice %}
        This will overwrite the existing AI advice. Are you sure you want to regenerate it?
      {% else %}
        This will generate AI suggestions based on the current PIP data.
      {% endif %}
    </p>
    <div class="flex justify-end space-x-4 pt-2">
      <button onclick="closeModal()" class="text-sm text-gray-600 hover:underline">Cancel</button>
      <form action="{{ url_for('generate_ai_advice', id=pip.id) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit"
                class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-sm font-medium">
          Yes, Proceed
        </button>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function openModal() {
    document.getElementById('aiModal').classList.remove('hidden');
    document.getElementById('aiModal').classList.add('flex');
  }
  function closeModal() {
    document.getElementById('aiModal').classList.remove('flex');
    document.getElementById('aiModal').classList.add('hidden');
  }
  function copyAdvice() {
    const el = document.getElementById('aiAdviceText');
    if (!el) return;
    const text = el.innerText || el.textContent || '';
    navigator.clipboard.writeText(text).then(()=>{
      // tiny toast
      const t = document.createElement('div');
      t.textContent = 'Copied!';
      t.className = 'fixed bottom-4 right-4 bg-[#005b5a] text-white px-3 py-1 rounded shadow';
      document.body.appendChild(t);
      setTimeout(()=> t.remove(), 1200);
    });
  }
</script>
{% endblock %}
