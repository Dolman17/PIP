{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto">
  <h1 class="text-2xl font-semibold mb-2">Edit Document ({{ doc.doc_type|capitalize }} v{{ doc.version }})</h1>
  <p class="text-sm text-gray-600 mb-6">Status: <span class="font-medium">{{ doc.status }}</span></p>

  <form method="post" onsubmit="return syncEditor();">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div id="editor"
         class="prose max-w-none bg-white rounded-2xl shadow p-6 border min-h-[60vh]"
         contenteditable="true">{{ html_content|safe }}</div>
    <textarea name="html" id="html" class="hidden"></textarea>

    <div class="mt-6 flex gap-3">
      <button class="px-4 py-2 rounded-2xl bg-[#005b5a] text-white">Save Draft</button>
      {% if doc.status != 'final' %}
      <button formaction="{{ url_for('finalise_pip_doc', pip_id=pip_rec.id, doc_id=doc.id) }}"
              formmethod="post"
              class="px-4 py-2 rounded-2xl bg-gray-900 text-white"
              onclick="return confirm('Finalise this document? This version will be locked (history preserved).')">
        Finalise
      </button>
      {% endif %}
      <a href="{{ url_for('download_doc', doc_id=doc.id) }}" class="px-4 py-2 rounded-2xl border">Download DOCX</a>
      <a href="{{ url_for('pip_documents', pip_id=pip_rec.id) }}" class="px-4 py-2 rounded-2xl border">Back to History</a>
    </div>
  </form>
</div>

<script>
function syncEditor(){
  const html = document.getElementById('editor').innerHTML;
  document.getElementById('html').value = html;
  return true;
}
</script>
{% endblock %}
